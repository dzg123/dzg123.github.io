<!DOCTYPE html>
<html lang="zh">
<head>
    <meta name="generator" content="Hugo 0.51">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="wap-font-scale" content="no">
    <meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34">
    <meta name="sogou_site_verification" content="E8uWFBcf4a">
    <meta name="author" content="dzg">
    <meta name="keywords" content="">
    <meta property="og:locale" content="en_US">
    <meta property="og:title" content=" dzg">
    <title>blog | dzg</title>
    <link rel="shortcut icon" href="/images/favicon.ico">
    <link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <script src="/lib/highlight.min.js">
    </script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/lib/jquery/jquery.min.js"></script>
    <script>
        document.addEventListener("error", function (e) {
            var elem = e.target;
            if (elem.tagName.toLowerCase() == 'img') {
                elem.style.display = 'none'
            }
        }, true);
    </script>
    
</head>
<body>
<div id="header-post">
    <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
    <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#"
                                                                              onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"
                                                                              style="display:none;"><i
        class="fa fa-chevron-up fa-lg"></i></a> <span
        id="menu"><span id="nav"><ul><li><a href="/">主页</a></li><li><a href="/blog/">博客</a></li><li><a
        href="/about/">关于我</a></li><li><a href="http://github.com/dzg123"
                                          target="_blank">Github</a></li></ul></span><br>

</span>
</div>
<div class="content index width mx-auto px3 my3">
    <section id="wrapper" class="home">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
            <header>
                <h1 class="posttitle" itemprop="name headline">商品异动检测-kats算法实现</h1>
                <div class="meta">
                    <div class="postdate">
                        <time datetime="2018-10-20" itemprop="datePublished">2023-07-05</time>
                    </div>
                    <div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span
                            id="busuanzi_value_page_pv">0</span></span></div>
                    <div class="article-tag"><i class="fa fa-tag"></i> <a href="/tags/algo">算法</a></div>
                    <div class="article-tag-box"></div>
                </div>
            </header>
            <!--markdown-->
            <div id='write'  class=''><h2 id='背景'><span>背景</span></h2><p><span>为服务好xx战役，需要对各个xg类目的表现情况做好监控，为此工程侧期望能够沉淀出一套异动情况、异动原因的快速/准确的反馈、归纳以及对未来是否还能维稳的预测能力。本次主要是以爆品商品订单的持续异常下滑为切入点，做订单异动检测算法工程化的设计。</span></p><h2 id='异动检测能力工程化目标'><span>异动检测能力工程化目标</span></h2><ul><li><p><strong><span>趋势变化检测</span></strong><span>：加速放缓、跌速增加</span></p></li><li><p><strong><span>趋势拐点检测</span></strong><span>：在某个时间点趋势发生变化</span></p></li><li><p><strong><span>时序异常检测</span></strong><span>：检测时序数据中的异常点</span></p></li><li><p><strong><span>趋势差异检测</span></strong><span>：比如某些品类商品的变化趋势和其他的明显不同</span></p></li></ul><h2 id='业界相关产品算法调研'><span>业界相关产品/算法调研</span></h2><p><span>在相对完善的指标体系建设背景下，我们需要通过指标以及指标波动的解读来描述、追踪、推动业务。当一个指标波动时，首先需要从业务视角判断其波动是否异常，即异动检测；其次判断异常背后的原因是什么，即异动归因。</span></p><h3 id='弹内相关产品调研'><span>弹内相关产品调研</span></h3><p><span>脱敏</span></p><p>&nbsp;</p><h3 id='业界公认算法'><span>业界公认算法</span></h3><p><span>常用的时序算法包括经典的时序统计模型ç, 异常检测模型Isolation Forest，深度学习模型AutoEncoder，以及工业界模型greykite/luminol(LinkedIn), Propet/Kats(Meta), Twitter-AD(Twitter), SR-CNN(Microsoft)</span></p><h4 id='优劣势对比'><span>优劣势对比</span></h4><p><span>算法按照数据要求、适用范围、精度、计算速度、准确度、计算速度、可解释性、算法灵活性几个维度做比较：</span></p><figure class='table-figure'><table><thead><tr><th><span>算法</span></th><th><span>数据要求</span></th><th><span>适用范围</span></th><th><span>精度</span></th><th><span>计算速度</span></th><th><span>准确度</span></th><th><span>可解释性</span></th><th><span>算法灵活性</span></th></tr></thead><tbody><tr><td><span>Arima</span></td><td><span>高</span></td><td><span>小规模数据</span></td><td><span>中</span></td><td><span>中</span></td><td><span>中</span></td><td><span>低</span></td><td><span>中</span></td></tr><tr><td><span>Isolation Forest</span></td><td><span>中</span></td><td><span>大规模数据</span></td><td><span>中</span></td><td><span>高</span></td><td><span>高</span></td><td><span>低</span></td><td><span>中</span></td></tr><tr><td><span>AutoEncoder</span></td><td><span>高</span></td><td><span>各种类型的数据</span></td><td><span>高</span></td><td><span>中</span></td><td><span>高</span></td><td><span>低</span></td><td><span>中</span></td></tr><tr><td><span>Greykite/Luminol(LinkedIn)</span></td><td><span>高</span></td><td><span>大规模数据</span></td><td><span>中</span></td><td><span>低</span></td><td><span>中</span></td><td><span>低</span></td><td><span>高</span></td></tr><tr><td><span>Propet/Kats(Meta)</span></td><td><span>高</span></td><td><span>大规模数据</span></td><td><span>中</span></td><td><span>中</span></td><td><span>中</span></td><td><span>高</span></td><td><span>高</span></td></tr><tr><td><span>Twitter-AD(Twitter)</span></td><td><span>中</span></td><td><span>大规模数据</span></td><td><span>中</span></td><td><span>中</span></td><td><span>中</span></td><td><span>低</span></td><td><span>高</span></td></tr><tr><td><span>SR-CNN(Microsoft)</span></td><td><span>高</span></td><td><span>大规模数据</span></td><td><span>高</span></td><td><span>低</span></td><td><span>高</span></td><td><span>低</span></td><td><span>中</span></td></tr></tbody></table></figure><ul><li><p><span>数据要求方面，Arima、AutoEncoder和SR-CNN的数据要求较高，而Isolation Forest和Twitter-AD的数据要求较低。</span></p></li><li><p><span>适用范围方面，Greykite/Luminol、Propet/Kats和Isolation Forest适用于大规模数据，Arima适用于小规模数据，AutoEncoder适用于各种类型的数据，而Twitter-AD适用于中等规模的数据。</span></p></li><li><p><span>精度方面，AutoEncoder和SR-CNN的精度较高，Isolation Forest和Greykite/Luminol的精度处于中等水平，Arima和Propet/Kats的精度较低。</span></p></li><li><p><span>计算速度方面，Isolation Forest和SR-CNN的计算速度较快，而Greykite/Luminol、Propet/Kats和Arima的计算速度较慢。</span></p></li><li><p><span>准确度方面，Isolation Forest和AutoEncoder的准确度较高，而其他算法的准确度则处于中等水平。</span></p></li><li><p><span>可解释性方面，Propet/Kats和AutoEncoder的可解释性较高，而Greykite/Luminol、Twitter-AD和SR-CNN的可解释性较低。</span></p></li><li><p><span>算法灵活性方面，Greykite/Luminol、Propet/Kats和Twitter-AD的灵活性较高，而其他算法的灵活性则处于中等水平。</span></p></li></ul><h4 id='数据集验证'><span>数据集验证</span></h4><p><img src="https://pic.imgdb.cn/item/64a67e881ddac507cce5c553.png" referrerpolicy="no-referrer" alt="img"></p><h4 id='结论'><span>结论</span></h4><p><strong><span>Kats+STL分解</span></strong><span>：对于季节性变化较为明显的订单指标，可以使用Kats中的STL分解算法进行异常检测。该算法将时间序列分解为三个部分：季节性、趋势性和残差部分，从而更好地进行异常检测</span></p><h4 id='应用算法简单介绍'><span>应用算法简单介绍</span></h4><p><span>Prophet是Meta推出的时间序列预测的开源库，其背后的原理是基于回归中的可加模型， 另外用分段线性或逻辑增长曲线模拟时序的趋势，用傅里叶级数模拟年周期，用虚拟变量模拟周周期，以及考虑了假期/事件对时序的影响。它适用于具有周期性和假期时间影响的时间序列， Prophet 对缺失数据和趋势变化具有鲁棒性，并且通常可以很好地处理异常值。 因为其提供统计显著及置信区间， 如果实际值在置信区间之外，可判断为是异常值。 所以其工具也可作为异常检测手段使用。</span></p><p><span>随后，Meta数据科学团队开发了一个叫Kats的Python工具包，将一系列的时序模型打包成可以复用的框架，以便使用者在上面进行一站式的时间序列分析：包含变点/异常值/趋势识别、时序预测、特征提取/嵌入、多变量分析等等。</span></p><h2 id='总体方案设计'><span>总体方案设计</span></h2><p><img src="https://pic.imgdb.cn/item/64a67e891ddac507cce5cb1e.png" referrerpolicy="no-referrer" alt="img"></p><p><img src="https://pic.imgdb.cn/item/64a67e931ddac507cce5f382.png" referrerpolicy="no-referrer" alt="img"></p><h2 id='方案'><span>方案</span></h2><p><span>脱敏</span></p><h2 id='算法报告'><span>算法报告</span></h2><h3 id='数据集'><span>数据集</span></h3><p><span>取直营最近一天的爆品商品近30天的每日订单数据做算法输入</span></p><ul><li><p><span>输入：xxxx.item_ord_detection_kats_algo_input（约3500个爆品）</span></p></li><li><p><span>输出：xxxx.item_ord_detection_kats_algo_res_opt</span></p></li></ul><p><span>本报告基于kats支持的几种异常检测器来开展：</span></p><p><img src="https://pic.imgdb.cn/item/64a67e8a1ddac507cce5cd9b.png" referrerpolicy="no-referrer" alt="img"></p><h3 id='各检测算法脚本'><span>各检测算法&amp;脚本</span></h3><p><span>官方算法文档：</span><a href='https://github.com/facebookresearch/Kats/blob/v0.2.0/tutorials/kats_202_detection.ipynb' target='_blank' class='url'>https://github.com/facebookresearch/Kats/blob/v0.2.0/tutorials/kats_202_detection.ipynb</a></p><p><img src="https://pic.imgdb.cn/item/64a67e911ddac507cce5e6f7.png" referrerpolicy="no-referrer" alt="img"></p><h4 id='cusumdetector-异常点检测'><span>CUSUMDetector 异常点检测</span></h4><p><span>CUSUM是一种</span><strong><span>检测时间序列中均值上升或下降变化</span></strong><span>的方法。实现有两个主要步骤：</span></p><ul><li><p><strong><span>Locate</span></strong><span>变化点：这是一个</span><strong><span>迭代过程</span></strong><span>，在时间序列的中间初始化一个变化点和CUSUM时间序列。下一个变化点是先前的CUSUM时间序列最大化（或最小化）的位置。这个迭代过程会一直持续，直到找到一个稳定的变化点或超过迭代次数的限制。</span></p></li><li><p><strong><span>Test</span></strong><span>变化点的统计学意义。进行</span><strong><span>对数似然比检验</span></strong><span>，以测试在步骤1中计算出的变化点是否存在时间序列均值的变化。零假设是均值不变。默认情况下，只有在步骤2中拒绝零假设时，我们才会报告检测到的变化点。</span></p></li></ul><p><span>CUSUMDetector具体可调试参数(标黄重点调试)：</span></p><figure class='table-figure'><table><thead><tr><th><span>参数key</span></th><th><span>含义</span></th><th><span>默认值/类型</span></th></tr></thead><tbody><tr><td><span>threshold</span></td><td><span>阀值</span></td><td><span>0.01/float</span></td></tr><tr><td><span>max_iter</span></td><td><span>寻找变化点的最大迭代次数</span></td><td><span>10/int</span></td></tr><tr><td><span>delta_std_ratio</span></td><td><span>平均值之差必须大于数据的标准差乘以这个参数才能被视为变化</span></td><td><span>1.0/float</span></td></tr><tr><td><span>min_abs_change</span></td><td><span>mu0和mu1之间的最小绝对差值(mu0: 变化点之前的平均值；mu1: 变化点之后的平均值；)</span></td><td><span>0/int</span></td></tr><tr><td><span>start_point</span></td><td><span>变化点的起始索引</span></td><td><span>None/Optional</span><a href='None表示时间序列的中间位置'><span>int</span></a></td></tr><tr><td><span>change_directions</span></td><td><span>一个包含“increase”和/或“decrease”的列表，用于指定要检测的变化类型</span></td><td><span>None/Optional[List[str]]</span></td></tr><tr><td><span>interest_window</span></td><td><span>一个包含兴趣窗口的起始和结束位置的列表，在该窗口中寻找变化点</span></td><td><span>None/Optional[Tuple[int, int]]</span></td></tr><tr><td><span>magnitude_quantile</span></td><td><span>大小比较的分位数</span></td><td><span>None/Optional</span><a href='None则跳过大小比较'><span>float</span></a></td></tr><tr><td><span>magnitude_ratio</span></td><td><span>可比较的比率</span></td><td><span>1.3/float</span></td></tr><tr><td><span>magnitude_comparable_day</span></td><td><span>可以具有可比较大小的最大天数的百分比，以便被视为回归</span></td><td><span>0.5/float</span></td></tr><tr><td><span>return_all_changepoints</span></td><td><span>返回发现的所有变化点，即使是不显著的。</span></td><td><span>False/bool</span></td></tr></tbody></table></figure><h5 id='单突变点检测脚本'><span>单突变点检测脚本</span></h5><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">def CUSUMDetectorMean<span class="cm-bracket">(</span>startDs<span class="cm-punctuation">,</span> <span class="cm-keyword">data</span><span class="cm-bracket">)</span><span class="cm-punctuation">:</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># synthesize data with simulation</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># orders = [54,59,72, 86, 177, 72, 76, 58, 45, 63, 55, 218, 217, 39, 17, 31, 31, 17, 16, 24, 27, 22, 28, 20, 29, 21, 25, 30, 20, 74, 145, 89, 30, 426, 53, 645, 542, 938, 171, 952, 780, 952, 1006, 914, 512, 596, 655, 610, 786, 952, 1198, 142, 128, 66, 87, 100, 74, 64, 106, 85, 86, 106]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># orders_one_m = [89, 30, 426, 53, 645, 542, 938, 171, 952, 780, 952, 1006, 914, 512, 596, 655, 610, 786, 952, 1198, 142, 128, 66, 87, 100, 74, 64, 106, 85, 86, 106]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  orders_one_m <span class="cm-operator">=</span> <span class="cm-keyword">data</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># np.random.seed(10)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  series <span class="cm-operator">=</span> pd<span class="cm-variable-2">.Series</span><span class="cm-bracket">(</span>orders_one_m<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  df_increase_decrease <span class="cm-operator">=</span> pd<span class="cm-variable-2">.DataFrame</span><span class="cm-bracket">(</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-bracket">{</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'time'</span><span class="cm-punctuation">:</span> pd<span class="cm-variable-2">.date_range</span><span class="cm-bracket">(</span>startDs<span class="cm-punctuation">,</span> periods<span class="cm-operator">=</span>len<span class="cm-bracket">(</span>series<span class="cm-bracket">))</span><span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'increase'</span><span class="cm-punctuation">:</span>series<span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'decrease'</span><span class="cm-punctuation">:</span>series<span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-bracket">}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">print</span><span class="cm-bracket">(</span><span class="cm-string">'TimeSeriesData data:'</span><span class="cm-punctuation">,</span>df_increase_decrease<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 突变点监测1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  tsd <span class="cm-operator">=</span> TimeSeriesData<span class="cm-bracket">(</span>df_increase_decrease<span class="cm-variable-2">.loc</span><span class="cm-bracket">[</span><span class="cm-punctuation">:,</span><span class="cm-bracket">[</span><span class="cm-string">'time'</span><span class="cm-punctuation">,</span><span class="cm-string">'increase'</span><span class="cm-bracket">]])</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  detector <span class="cm-operator">=</span> CUSUMDetector<span class="cm-bracket">(</span>tsd<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  change_points <span class="cm-operator">=</span> detector<span class="cm-variable-2">.detector</span><span class="cm-bracket">(</span>change_directions<span class="cm-operator">=</span><span class="cm-bracket">[</span><span class="cm-string">"increase"</span><span class="cm-bracket">]</span><span class="cm-punctuation">,</span> return_all_changepoints<span class="cm-operator">=</span><span class="cm-atom">True</span><span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">print</span><span class="cm-bracket">(</span><span class="cm-string">'CUSUMDetector 突变点监测1:'</span><span class="cm-punctuation">,</span>change_points<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 突变点监测2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  tsd <span class="cm-operator">=</span> TimeSeriesData<span class="cm-bracket">(</span>df_increase_decrease<span class="cm-variable-2">.loc</span><span class="cm-bracket">[</span><span class="cm-punctuation">:,</span><span class="cm-bracket">[</span><span class="cm-string">'time'</span><span class="cm-punctuation">,</span><span class="cm-string">'decrease'</span><span class="cm-bracket">]])</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  detector <span class="cm-operator">=</span> CUSUMDetector<span class="cm-bracket">(</span>tsd<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  change_points <span class="cm-operator">=</span> detector<span class="cm-variable-2">.detector</span><span class="cm-bracket">(</span>change_directions<span class="cm-operator">=</span><span class="cm-bracket">[</span><span class="cm-string">"decrease"</span><span class="cm-bracket">])</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">print</span><span class="cm-bracket">(</span><span class="cm-string">'CUSUMDetector 突变点监测2:'</span><span class="cm-punctuation">,</span>change_points<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  detector<span class="cm-variable-2">.plot</span><span class="cm-bracket">(</span>change_points<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> changePToDict<span class="cm-bracket">(</span>change_points<span class="cm-bracket">)</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 792px;"></div><div class="CodeMirror-gutters" style="display: none; height: 792px;"></div></div></div></pre><h5 id='多突变点检测脚本'><span>多突变点检测脚本</span></h5><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">def CUSUMDetectorWithMultipleChangeP<span class="cm-bracket">(</span>startDs<span class="cm-punctuation">,</span> <span class="cm-keyword">data</span><span class="cm-bracket">)</span><span class="cm-punctuation">:</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># orders_one_m = [89, 30, 426, 53, 645, 542, 938, 171, 952, 780, 952, 1006, 914, 512, 596, 655, 610, 786, 952, 1198, 142, 128, 66, 87, 100, 74, 64, 106, 85, 86, 106]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  orders_one_m <span class="cm-operator">=</span> <span class="cm-keyword">data</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  series <span class="cm-operator">=</span> pd<span class="cm-variable-2">.Series</span><span class="cm-bracket">(</span>orders_one_m<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  df_multi_cps <span class="cm-operator">=</span> pd<span class="cm-variable-2">.DataFrame</span><span class="cm-bracket">(</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-bracket">{</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'time'</span><span class="cm-punctuation">:</span> pd<span class="cm-variable-2">.date_range</span><span class="cm-bracket">(</span>startDs<span class="cm-punctuation">,</span> periods<span class="cm-operator">=</span>len<span class="cm-bracket">(</span>series<span class="cm-bracket">))</span><span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'y'</span><span class="cm-punctuation">:</span>series</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;<span class="cm-bracket">}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  multi_cp_ts <span class="cm-operator">=</span> TimeSeriesData<span class="cm-bracket">(</span>df_multi_cps<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># print('CUSUMDetectorWithMultipleChangePTest input:',multi_cp_ts)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  historical_window <span class="cm-operator">=</span> <span class="cm-number">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  scan_window <span class="cm-operator">=</span> <span class="cm-number">10</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  step <span class="cm-operator">=</span> <span class="cm-number">5</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  changepoints <span class="cm-operator">=</span> <span class="cm-bracket">[]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  n <span class="cm-operator">=</span> len<span class="cm-bracket">(</span>df_multi_cps<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">for</span> end_idx <span class="cm-keyword">in</span> <span class="cm-keyword">range</span><span class="cm-bracket">(</span>historical_window <span class="cm-operator">+</span> scan_window<span class="cm-punctuation">,</span> n<span class="cm-punctuation">,</span> step<span class="cm-bracket">)</span><span class="cm-punctuation">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  tsd <span class="cm-operator">=</span> multi_cp_ts<span class="cm-bracket">[</span>end_idx <span class="cm-operator">-</span> <span class="cm-bracket">(</span>historical_window <span class="cm-operator">+</span> scan_window<span class="cm-bracket">)</span> <span class="cm-punctuation">:</span> end_idx<span class="cm-bracket">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin">print</span><span class="cm-bracket">(</span><span class="cm-string">'多窗口输入检测input:'</span><span class="cm-punctuation">,</span>tsd<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  changepoints <span class="cm-operator">+=</span> CUSUMDetector<span class="cm-bracket">(</span>tsd<span class="cm-bracket">)</span><span class="cm-variable-2">.detector</span><span class="cm-bracket">(</span>change_directions<span class="cm-operator">=</span><span class="cm-bracket">[</span><span class="cm-string">"decrease"</span><span class="cm-bracket">]</span><span class="cm-punctuation">,</span>interest_window<span class="cm-operator">=</span><span class="cm-bracket">[</span>historical_window<span class="cm-punctuation">,</span> historical_window <span class="cm-operator">+</span> scan_window<span class="cm-bracket">]</span><span class="cm-punctuation">,</span>max_iter<span class="cm-operator">=</span><span class="cm-number">15</span><span class="cm-punctuation">,</span>return_all_changepoints<span class="cm-operator">=</span><span class="cm-atom">True</span><span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">print</span><span class="cm-bracket">(</span><span class="cm-string">'CUSUMDetector 多异常点检测:'</span><span class="cm-punctuation">,</span>changepoints<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> changePToDict<span class="cm-bracket">(</span>changepoints<span class="cm-bracket">)</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 616px;"></div><div class="CodeMirror-gutters" style="display: none; height: 616px;"></div></div></div></pre><h4 id='bocpdetector-贝叶斯异常区间检测'><span>BOCPDetector 贝叶斯异常区间检测</span></h4><p><span>贝叶斯在线变点检测（BOCPD）是一种用于检测时间序列中持续存在突变的方法。实现基于论文《</span><a href='https://arxiv.org/abs/0710.3742'><span>Bayesian Online Changepoint Detection</span></a><span>》（Adams＆McKay，2007）。</span></p><p><span>有几个特性将BOCPD与Kats支持的其他变点检测方法区分开来：</span></p><ul><li><p><span>在线模型：这种检测不需要预先知道整个序列。它只需要向前查看几步（由检测器方法中的滞后参数指定）进行预测，并在新数据到达时修正预测。</span></p></li><li><p><span>贝叶斯模型：用户可以指定关于变点概率的先验信念（使用检测器方法中的changepoint_prior参数），并指定生成时间序列的潜在概率模型的参数（使用检测器方法中的model_parameters参数）。目前，我们支持三种不同类型的潜在概率模型（使用检测器方法中的model参数指定）。</span></p></li></ul><p><span>BOCPD检测方法的基本思想是使用贝叶斯推理来判断下一个点是否为变点。这要求用户指定（或使用默认值）变点概率和生成时间序列中传入数据点的潜在预测模型（UPM）。目前算法支持三种不同类型的潜在模型：</span></p><ul><li><p><span>正态分布（未知均值，已知方差）</span></p></li><li><p><span>趋势变化分布</span></p></li><li><p><span>Poisson过程模型</span></p></li></ul><p><span>BOCPDetector具体可调试参数(标黄重点调试)：</span></p><figure class='table-figure'><table><thead><tr><th><span>参数key</span></th><th><span>含义</span></th><th><span>默认值/类型</span></th></tr></thead><tbody><tr><td><span>model</span></td><td><span>生成每个段内数据的潜在概率模型</span></td><td><span>NORMAL_KNOWN_MODEL：已知方差的正态模型。使用此模型查找通常分布数据中的水平移位。TREND_CHANGE_MODEL：该模型假设每个段都是由普通线性回归生成的。使用此模型了解时间序列中的斜率或趋势的变化。POISSON_PROCESS_MODEL：这假设Poisson生成模型。将其用于计数数据，其中大多数值接近于零</span></td></tr><tr><td><span>model_parameters</span></td><td><span>模型参数对应于特定模型的特定参数</span></td><td><span>模型对应的参数体：NormalKnownParameters，TrendChangeParameters，PoissonModelParameters</span></td></tr><tr><td><span>lag</span></td><td><span>指向检测变点的滞后。在看到“滞后”数量的数据点后报告变点。更高的滞后会更确定这确实是一个变点。较低的滞后将更快地检测到变点。这是一个权衡。</span></td><td><span>10/int</span></td></tr><tr><td><span>changepoint_prior</span></td><td><span>这是一种贝叶斯算法。此参数指定了给定点是变点的先验概率</span></td><td><span>True/bool</span></td></tr><tr><td><span>threshold</span></td><td><span>在每个时刻报告观察变点的概率，通过将超过此阈值的点标记为变点来获得实际的变点</span></td><td><span>0.5/float</span></td></tr><tr><td><span>debug</span></td><td><span>允许用户查看为什么变点未能正确检测的调试信息</span></td><td><span>False/bool</span></td></tr></tbody></table></figure><h5 id='检测脚本'><span>检测脚本</span></h5><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">def BOCPDetectorAM<span class="cm-bracket">(</span>startDs<span class="cm-punctuation">,</span> <span class="cm-keyword">data</span><span class="cm-bracket">)</span><span class="cm-punctuation">:</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># from kats.utils.simulator import Simulator</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># sim = Simulator(n=450, start='2020-01-01', freq='H')</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># ts_bocpd = sim.level_shift_sim(noise=0.05, seasonal_period=1)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  orders_one_m <span class="cm-operator">=</span> <span class="cm-keyword">data</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  series <span class="cm-operator">=</span> pd<span class="cm-variable-2">.Series</span><span class="cm-bracket">(</span>orders_one_m<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  df <span class="cm-operator">=</span> pd<span class="cm-variable-2">.DataFrame</span><span class="cm-bracket">(</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-bracket">{</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'time'</span><span class="cm-punctuation">:</span> pd<span class="cm-variable-2">.date_range</span><span class="cm-bracket">(</span>startDs<span class="cm-punctuation">,</span> periods<span class="cm-operator">=</span>len<span class="cm-bracket">(</span>series<span class="cm-bracket">))</span><span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'value'</span><span class="cm-punctuation">:</span>series</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-bracket">}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ts_bocpd <span class="cm-operator">=</span> TimeSeriesData<span class="cm-bracket">(</span>df<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">print</span><span class="cm-bracket">(</span><span class="cm-string">'BOCPDetector input:'</span><span class="cm-punctuation">,</span>ts_bocpd<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># Initialize the detector</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  detector <span class="cm-operator">=</span> BOCPDetector<span class="cm-bracket">(</span>ts_bocpd<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  changepoints <span class="cm-operator">=</span> detector<span class="cm-variable-2">.detector</span><span class="cm-bracket">()</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">print</span><span class="cm-bracket">(</span><span class="cm-string">'BOCPDetector input:'</span><span class="cm-punctuation">,</span>changepoints<span class="cm-bracket">)</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 484px;"></div><div class="CodeMirror-gutters" style="display: none; height: 484px;"></div></div></div></pre><h4 id='robuststatdetector多突变点检测'><span>RobustStatDetector多突变点检测</span></h4><p><span>RobustStatDetector是一种变点检测算法，类似于CUSUMDetector，用于发现均值变化。其工作方式如下：</span></p><ol start='' ><li><p><span>使用移动平均法对时间序列进行平滑处理；</span></p></li><li><p><span>计算平滑时间序列中一定数量的数据点（由detector方法中的comparison_window参数指定）之间的差异；</span></p></li><li><p><span>计算差异的z-scores和p-values。返回p-value小于预定阈值的点（由detector方法中的p_value_cutoff参数指定）；</span></p></li><li><p><span>与CUSUMDetector不同，RobustStatDetector可以在单次运行中检测多个变点。</span></p></li></ol><p><span>RobustStatDetector具体可调试参数(标黄重点调试)：</span></p><figure class='table-figure'><table><thead><tr><th><span>参数key</span></th><th><span>含义</span></th><th><span>默认值/类型</span></th></tr></thead><tbody><tr><td><span>p_value_cutoff</span></td><td><span>标记变点的p-value阈值</span></td><td><span>1e-2/float</span></td></tr><tr><td><span>smoothing_window_size</span></td><td><span>平滑窗口的长度</span></td><td><span>5/int</span></td></tr><tr><td><span>comparison_window</span></td><td><span>diff函数的步长，即算法查看多少数据点来进行比较。</span></td><td><span>-2/int</span></td></tr></tbody></table></figure><h5 id='检测脚本-2'><span>检测脚本</span></h5><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">def RobustStatDetectorMean<span class="cm-bracket">(</span>startDs<span class="cm-punctuation">,</span> <span class="cm-keyword">data</span><span class="cm-bracket">)</span><span class="cm-punctuation">:</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  orders <span class="cm-operator">=</span> <span class="cm-bracket">[</span><span class="cm-number">54</span><span class="cm-punctuation">,</span><span class="cm-number">59</span><span class="cm-punctuation">,</span><span class="cm-number">72</span><span class="cm-punctuation">,</span> <span class="cm-number">86</span><span class="cm-punctuation">,</span> <span class="cm-number">177</span><span class="cm-punctuation">,</span> <span class="cm-number">72</span><span class="cm-punctuation">,</span> <span class="cm-number">76</span><span class="cm-punctuation">,</span> <span class="cm-number">58</span><span class="cm-punctuation">,</span> <span class="cm-number">45</span><span class="cm-punctuation">,</span> <span class="cm-number">63</span><span class="cm-punctuation">,</span> <span class="cm-number">55</span><span class="cm-punctuation">,</span> <span class="cm-number">218</span><span class="cm-punctuation">,</span> <span class="cm-number">217</span><span class="cm-punctuation">,</span> <span class="cm-number">39</span><span class="cm-punctuation">,</span> <span class="cm-number">17</span><span class="cm-punctuation">,</span> <span class="cm-number">31</span><span class="cm-punctuation">,</span> <span class="cm-number">31</span><span class="cm-punctuation">,</span> <span class="cm-number">17</span><span class="cm-punctuation">,</span> <span class="cm-number">16</span><span class="cm-punctuation">,</span> <span class="cm-number">24</span><span class="cm-punctuation">,</span> <span class="cm-number">27</span><span class="cm-punctuation">,</span> <span class="cm-number">22</span><span class="cm-punctuation">,</span> <span class="cm-number">28</span><span class="cm-punctuation">,</span> <span class="cm-number">20</span><span class="cm-punctuation">,</span> <span class="cm-number">29</span><span class="cm-punctuation">,</span> <span class="cm-number">21</span><span class="cm-punctuation">,</span> <span class="cm-number">25</span><span class="cm-punctuation">,</span> <span class="cm-number">30</span><span class="cm-punctuation">,</span> <span class="cm-number">20</span><span class="cm-punctuation">,</span> <span class="cm-number">74</span><span class="cm-punctuation">,</span> <span class="cm-number">145</span><span class="cm-punctuation">,</span> <span class="cm-number">89</span><span class="cm-punctuation">,</span> <span class="cm-number">30</span><span class="cm-punctuation">,</span> <span class="cm-number">426</span><span class="cm-punctuation">,</span> <span class="cm-number">53</span><span class="cm-punctuation">,</span> <span class="cm-number">645</span><span class="cm-punctuation">,</span> <span class="cm-number">542</span><span class="cm-punctuation">,</span> <span class="cm-number">938</span><span class="cm-punctuation">,</span> <span class="cm-number">171</span><span class="cm-punctuation">,</span> <span class="cm-number">952</span><span class="cm-punctuation">,</span> <span class="cm-number">780</span><span class="cm-punctuation">,</span> <span class="cm-number">952</span><span class="cm-punctuation">,</span> <span class="cm-number">1006</span><span class="cm-punctuation">,</span> <span class="cm-number">914</span><span class="cm-punctuation">,</span> <span class="cm-number">512</span><span class="cm-punctuation">,</span> <span class="cm-number">596</span><span class="cm-punctuation">,</span> <span class="cm-number">655</span><span class="cm-punctuation">,</span> <span class="cm-number">610</span><span class="cm-punctuation">,</span> <span class="cm-number">786</span><span class="cm-punctuation">,</span> <span class="cm-number">952</span><span class="cm-punctuation">,</span> <span class="cm-number">1198</span><span class="cm-punctuation">,</span> <span class="cm-number">142</span><span class="cm-punctuation">,</span> <span class="cm-number">128</span><span class="cm-punctuation">,</span> <span class="cm-number">66</span><span class="cm-punctuation">,</span> <span class="cm-number">87</span><span class="cm-punctuation">,</span> <span class="cm-number">100</span><span class="cm-punctuation">,</span> <span class="cm-number">74</span><span class="cm-punctuation">,</span> <span class="cm-number">64</span><span class="cm-punctuation">,</span> <span class="cm-number">106</span><span class="cm-punctuation">,</span> <span class="cm-number">85</span><span class="cm-punctuation">,</span> <span class="cm-number">86</span><span class="cm-punctuation">,</span> <span class="cm-number">106</span><span class="cm-bracket">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># orders_one_m = [89, 30, 426, 53, 645, 542, 938, 171, 952, 780, 952, 1006, 914, 512, 596, 655, 610, 786, 952, 1198, 142, 128, 66, 87, 100, 74, 64, 106, 85, 86, 106]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># np.random.seed(10)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  orders_one_m <span class="cm-operator">=</span> <span class="cm-keyword">data</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  series <span class="cm-operator">=</span> pd<span class="cm-variable-2">.Series</span><span class="cm-bracket">(</span>orders_one_m<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  df_increase_decrease <span class="cm-operator">=</span> pd<span class="cm-variable-2">.DataFrame</span><span class="cm-bracket">(</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-bracket">{</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'time'</span><span class="cm-punctuation">:</span> pd<span class="cm-variable-2">.date_range</span><span class="cm-bracket">(</span>startDs<span class="cm-punctuation">,</span> periods<span class="cm-operator">=</span>len<span class="cm-bracket">(</span>series<span class="cm-bracket">))</span><span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'value'</span><span class="cm-punctuation">:</span>series</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 'increase':series,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 'decrease':series</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-bracket">}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">print</span><span class="cm-bracket">(</span><span class="cm-string">'BOCPDetector input:'</span><span class="cm-punctuation">,</span>df_increase_decrease<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  tsd <span class="cm-operator">=</span> TimeSeriesData<span class="cm-bracket">(</span>df_increase_decrease<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  detector <span class="cm-operator">=</span> RobustStatDetector<span class="cm-bracket">(</span>tsd<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  change_points <span class="cm-operator">=</span> detector<span class="cm-variable-2">.detector</span><span class="cm-bracket">(</span>p_value_cutoff <span class="cm-operator">=</span> <span class="cm-number">5e-3</span><span class="cm-punctuation">,</span> comparison_window<span class="cm-operator">=</span><span class="cm-number">2</span><span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">print</span><span class="cm-bracket">(</span><span class="cm-string">'RobustStatDetector 突变点监测:'</span><span class="cm-punctuation">,</span>change_points<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> changePToDict<span class="cm-bracket">(</span>change_points<span class="cm-punctuation">,</span><span class="cm-string">'TimeSeriesChangePoint'</span><span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 转为字典</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">def changePToDict<span class="cm-bracket">(</span>changepoints<span class="cm-punctuation">,</span>dictType<span class="cm-operator">=</span>None<span class="cm-bracket">)</span><span class="cm-punctuation">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  cp_dict_list <span class="cm-operator">=</span> <span class="cm-bracket">[]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> dictType <span class="cm-keyword">is</span> None <span class="cm-keyword">or</span>  dictType <span class="cm-operator">==</span> <span class="cm-string">''</span><span class="cm-punctuation">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">for</span> cp <span class="cm-keyword">in</span> changepoints<span class="cm-punctuation">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  happenTime <span class="cm-operator">=</span> cp<span class="cm-variable-2">.start_time</span> <span class="cm-operator">+</span> timedelta<span class="cm-bracket">(</span>days<span class="cm-operator">=</span><span class="cm-number">1</span><span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  cp_dict <span class="cm-operator">=</span> <span class="cm-bracket">{</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'start_time'</span><span class="cm-punctuation">:</span> cp<span class="cm-variable-2">.start_time</span><span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'end_time'</span><span class="cm-punctuation">:</span> cp<span class="cm-variable-2">.end_time</span><span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'happen_time'</span><span class="cm-punctuation">:</span> happenTime<span class="cm-variable-2">.strftime</span><span class="cm-bracket">(</span><span class="cm-string">'%Y%m%d'</span><span class="cm-bracket">)</span><span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'confidence'</span><span class="cm-punctuation">:</span> cp<span class="cm-variable-2">.confidence</span><span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'direction'</span><span class="cm-punctuation">:</span> cp<span class="cm-variable-2">.direction</span><span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'delta'</span><span class="cm-punctuation">:</span> cp<span class="cm-variable-2">.delta</span><span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'regression_detected'</span><span class="cm-punctuation">:</span> str<span class="cm-bracket">(</span>cp<span class="cm-variable-2">.regression_detected</span><span class="cm-bracket">)</span><span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'stable_changepoint'</span><span class="cm-punctuation">:</span> str<span class="cm-bracket">(</span>cp<span class="cm-variable-2">.stable_changepoint</span><span class="cm-bracket">)</span><span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'mu0'</span><span class="cm-punctuation">:</span> cp<span class="cm-variable-2">.mu0</span><span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'mu1'</span><span class="cm-punctuation">:</span> cp<span class="cm-variable-2">.mu1</span><span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'llr'</span><span class="cm-punctuation">:</span> cp<span class="cm-variable-2">.llr</span><span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'llr_int'</span><span class="cm-punctuation">:</span> cp<span class="cm-variable-2">.llr_int</span><span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'p_value'</span><span class="cm-punctuation">:</span> cp<span class="cm-variable-2">.p_value</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-punctuation">,</span><span class="cm-string">'p_value_int'</span><span class="cm-punctuation">:</span> cp<span class="cm-variable-2">.p_value_int</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-bracket">}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  cp_dict_list<span class="cm-variable-2">.append</span><span class="cm-bracket">(</span>cp_dict<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  elif dictType <span class="cm-operator">==</span> <span class="cm-string">'TimeSeriesChangePoint'</span><span class="cm-punctuation">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> cp <span class="cm-keyword">in</span> changepoints<span class="cm-punctuation">:</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># 返回的是timestamp类型 </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  happenTime <span class="cm-operator">=</span> pd<span class="cm-variable-2">.to_datetime</span><span class="cm-bracket">(</span>cp<span class="cm-variable-2">.start_time</span><span class="cm-bracket">)</span> <span class="cm-operator">+</span> timedelta<span class="cm-bracket">(</span>days<span class="cm-operator">=</span><span class="cm-number">1</span><span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  cp_dict <span class="cm-operator">=</span> <span class="cm-bracket">{</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'start_time'</span><span class="cm-punctuation">:</span> pd<span class="cm-variable-2">.to_datetime</span><span class="cm-bracket">(</span>cp<span class="cm-variable-2">.start_time</span><span class="cm-bracket">)</span><span class="cm-variable-2">.strftime</span><span class="cm-bracket">(</span><span class="cm-string">'%Y%m%d'</span><span class="cm-bracket">)</span><span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'end_time'</span><span class="cm-punctuation">:</span> pd<span class="cm-variable-2">.to_datetime</span><span class="cm-bracket">(</span>cp<span class="cm-variable-2">.end_time</span><span class="cm-bracket">)</span><span class="cm-variable-2">.strftime</span><span class="cm-bracket">(</span><span class="cm-string">'%Y%m%d'</span><span class="cm-bracket">)</span><span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'happen_time'</span><span class="cm-punctuation">:</span> happenTime<span class="cm-variable-2">.strftime</span><span class="cm-bracket">(</span><span class="cm-string">'%Y%m%d'</span><span class="cm-bracket">)</span><span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'confidence'</span><span class="cm-punctuation">:</span> cp<span class="cm-variable-2">.confidence</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-bracket">}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  cp_dict_list<span class="cm-variable-2">.append</span><span class="cm-bracket">(</span>cp_dict<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">print</span><span class="cm-bracket">(</span><span class="cm-string">'changePToDict:'</span><span class="cm-punctuation">,</span>cp_dict_list<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> json<span class="cm-variable-2">.dumps</span><span class="cm-bracket">(</span>cp_dict_list<span class="cm-bracket">)</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 1342px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1342px;"></div></div></div></pre><h4 id='outlierdetector离群点检测'><span>OutlierDetector离群点检测</span></h4><p><span>Kats提供了OutlierDetector模块来检测时间序列中的异常值。由于异常值可能会在下游处理中引起很多问题，因此能够检测它们非常重要。OutlierDetector还提供了处理或删除找到的异常值的功能。 </span></p><p><span>异常值检测算法如下： </span></p><ol start='' ><li><p><span>对输入时间序列进行季节分解，使用指定的加法或乘法分解（默认为加法）。 </span></p></li><li><p><span>通过仅删除趋势或删除趋势和季节性（如果季节性很强）来生成残差时间序列。 </span></p></li><li><p><span>.检测残差中超出3倍四分位距的点。可以使用OutlierDetector中的iqr_mult参数调整此乘数。 </span></p></li></ol><p><span>OutlierDetector具体可调试参数(标黄重点调试)：</span></p><figure class='table-figure'><table><thead><tr><th><span>参数key</span></th><th><span>含义</span></th><th><span>默认值/类型</span></th></tr></thead><tbody><tr><td><span>decomp</span></td><td><span>加法或乘法</span></td><td><span>&#39;additive&#39;/str</span></td></tr><tr><td><span>iqr_mult</span></td><td><span>四分位距上的乘数用于分类异常值</span></td><td><span>3.0/float</span></td></tr></tbody></table></figure><h5 id='检测脚本-3'><span>检测脚本</span></h5><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">def OutlierDetectorDecomp<span class="cm-bracket">(</span>startDs<span class="cm-punctuation">,</span> <span class="cm-keyword">data</span><span class="cm-bracket">)</span><span class="cm-punctuation">:</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  orders_one_m <span class="cm-operator">=</span> <span class="cm-keyword">data</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  series <span class="cm-operator">=</span> pd<span class="cm-variable-2">.Series</span><span class="cm-bracket">(</span>orders_one_m<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  df_increase_decrease <span class="cm-operator">=</span> pd<span class="cm-variable-2">.DataFrame</span><span class="cm-bracket">(</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-bracket">{</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'time'</span><span class="cm-punctuation">:</span> pd<span class="cm-variable-2">.date_range</span><span class="cm-bracket">(</span>startDs<span class="cm-punctuation">,</span> periods<span class="cm-operator">=</span>len<span class="cm-bracket">(</span>series<span class="cm-bracket">))</span><span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'value'</span><span class="cm-punctuation">:</span>series</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-bracket">}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">print</span><span class="cm-bracket">(</span><span class="cm-string">'TimeSeriesData data:'</span><span class="cm-punctuation">,</span>df_increase_decrease<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  tsd <span class="cm-operator">=</span> TimeSeriesData<span class="cm-bracket">(</span>df_increase_decrease<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ts_outlierDetection <span class="cm-operator">=</span> OutlierDetector<span class="cm-bracket">(</span>tsd<span class="cm-punctuation">,</span> <span class="cm-string">'additive'</span><span class="cm-bracket">)</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  ts_outlierDetection<span class="cm-variable-2">.detector</span><span class="cm-bracket">()</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">print</span><span class="cm-bracket">(</span><span class="cm-string">'OutlierDetectorDecomp 离群点:'</span><span class="cm-punctuation">,</span>ts_outlierDetection<span class="cm-variable-2">.outliers</span><span class="cm-bracket">[</span><span class="cm-number">0</span><span class="cm-bracket">])</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> changePToDict<span class="cm-bracket">(</span>ts_outlierDetection<span class="cm-variable-2">.outliers</span><span class="cm-bracket">[</span><span class="cm-number">0</span><span class="cm-bracket">]</span><span class="cm-punctuation">,</span> <span class="cm-string">'time_series'</span><span class="cm-bracket">)</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 352px;"></div><div class="CodeMirror-gutters" style="display: none; height: 352px;"></div></div></div></pre><h4 id='multivariateanomalydetector跨时序检测'><span>MultivariateAnomalyDetector跨时序检测</span></h4><p><span>MultivariateAnomalyDetector异常检测方法非常适用于跨多个时间序列检测异常。异常是基于与预测稳定状态行为的偏差检测出来的。通过使用向量自回归（VAR）模型对时间序列之间的线性相互依赖关系进行建模，可以预测指标系统的稳定状态行为。这种方法尤其适用于检测多变量异常 - 即</span><strong><span>在多个时间序列中持续存在的小异常</span></strong><span>。</span></p><h5 id='检测脚本-4'><span>检测脚本</span></h5><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">def MultivariateAnomalyDetectorCrossMultiSeries<span class="cm-bracket">(</span>startDs<span class="cm-punctuation">,</span> <span class="cm-keyword">data</span><span class="cm-bracket">)</span><span class="cm-punctuation">:</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  orders_one_m <span class="cm-operator">=</span> <span class="cm-keyword">data</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  series <span class="cm-operator">=</span> pd<span class="cm-variable-2">.Series</span><span class="cm-bracket">(</span>orders_one_m<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  df_increase_decrease <span class="cm-operator">=</span> pd<span class="cm-variable-2">.DataFrame</span><span class="cm-bracket">(</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-bracket">{</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'time'</span><span class="cm-punctuation">:</span> pd<span class="cm-variable-2">.date_range</span><span class="cm-bracket">(</span>startDs<span class="cm-punctuation">,</span> periods<span class="cm-operator">=</span>len<span class="cm-bracket">(</span>series<span class="cm-bracket">))</span><span class="cm-punctuation">,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">'value'</span><span class="cm-punctuation">:</span>series</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-bracket">}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">print</span><span class="cm-bracket">(</span><span class="cm-string">'TimeSeriesData data:'</span><span class="cm-punctuation">,</span>df_increase_decrease<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  multi_anomaly_ts <span class="cm-operator">=</span> TimeSeriesData<span class="cm-bracket">(</span>df_increase_decrease<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  params <span class="cm-operator">=</span> VARParams<span class="cm-bracket">(</span>maxlags<span class="cm-operator">=</span><span class="cm-number">2</span><span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  d <span class="cm-operator">=</span> MultivariateAnomalyDetector<span class="cm-bracket">(</span>multi_anomaly_ts<span class="cm-punctuation">,</span> params<span class="cm-punctuation">,</span> training_days<span class="cm-operator">=</span><span class="cm-number">60</span><span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  anomaly_score_df <span class="cm-operator">=</span> d<span class="cm-variable-2">.detector</span><span class="cm-bracket">()</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">print</span><span class="cm-bracket">(</span><span class="cm-string">'MultivariateAnomalyDetector anomaly_score_df:'</span><span class="cm-punctuation">,</span>anomaly_score_df<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment"># 检测</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  anomalies <span class="cm-operator">=</span> d<span class="cm-variable-2">.get_anomaly_timepoints</span><span class="cm-bracket">(</span>alpha<span class="cm-operator">=</span><span class="cm-number">0.05</span><span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">print</span><span class="cm-bracket">(</span><span class="cm-string">'MultivariateAnomalyDetector 离群点:'</span><span class="cm-punctuation">,</span>anomalies<span class="cm-bracket">)</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 418px;"></div><div class="CodeMirror-gutters" style="display: none; height: 418px;"></div></div></div></pre><h3 id='检测结果比对'><span>检测结果比对</span></h3><h5 id='算法参数'><span>算法参数</span></h5><p><span>详情见脚本：kats2_1.py（直营爆品近30天口径）</span></p><h5 id='策略'><span>策略</span></h5><ul><li><p><span>Base策略：基于置信度confidence倒序取大于0.7的检测结果</span></p></li><li><p><span>策略1：各检测算法结果的交集/并集</span></p></li><li><p><span>策略2：部分检测算法结果的并集+部分检测算法结果的交集</span></p></li></ul><h5 id='数据分析'><span>数据&amp;分析</span></h5><figure class='table-figure'><table><thead><tr><th><span>商品id</span></th><th><span>检测结果</span></th><th><span>解析</span></th></tr></thead><tbody><tr><td><span>628032051803</span></td><td><img src="https://pic.imgdb.cn/item/64a67e881ddac507cce5c663.png" referrerpolicy="no-referrer" alt="img"></td><td><span>CUSUMDetector单突变点检测出的日期：0611； CUSUMDetector多突变点检测出日期：0611，0621；OutlierDetector离群点检测出0609、0611</span></td></tr><tr><td><span>610295940401</span></td><td><img src="https://pic.imgdb.cn/item/64a67e8a1ddac507cce5cf68.png" referrerpolicy="no-referrer" alt="img"></td><td><span>CUSUMDetector单突变点检测出的日期：0703； CUSUMDetector多突变点检测出日期：0619，0621；RobustStatDetector离群点检测出0628</span></td></tr><tr><td><span>620189523811</span></td><td><img src="https://pic.imgdb.cn/item/64a67e911ddac507cce5eaf0.png" referrerpolicy="no-referrer" alt="img"></td><td><span>CUSUMDetector多突变点检测出日期：0630；RobustStatDetector离群点检测出0630、0702、0703</span></td></tr></tbody></table></figure><h3 id='生产检测链路'><span>生产检测链路</span></h3><p><img src="https://pic.imgdb.cn/item/64a67e911ddac507cce5e985.png" referrerpolicy="no-referrer" alt="img"></p><ul><li><p><span>核心脚本</span></p></li></ul><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="python" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre>x</pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># kats算法依赖的lib压缩后超过100M限制，排除掉pyODPS自带的基础包后压缩如果不满足要求，可以将其他包通过系统path引入</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">load_resource_package</span>(<span class="cm-string">"kats-deps_01.tar.gz"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">load_resource_package</span>(<span class="cm-string">"kats-deps_02_exclude.tar.gz"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">load_resource_package</span>(<span class="cm-string">"kats-deps_03_exclude.tar.gz"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">sys</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">os</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">platform</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">print</span>(<span class="cm-string">"Python版本："</span>, <span class="cm-variable">platform</span>.<span class="cm-property">python_version</span>())</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 必须解压statsmodels包,否则使用不了so链接库</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Pillow_archive_file</span> <span class="cm-operator">=</span> <span class="cm-string">'http://xxx.com/scheduler/res?id=265642211'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Pillow_archive_file_dir</span> <span class="cm-operator">=</span> <span class="cm-variable">os</span>.<span class="cm-property">path</span>.<span class="cm-property">dirname</span>(<span class="cm-variable">Pillow_archive_file</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">os</span>.<span class="cm-property">system</span>(<span class="cm-string">'unzip '</span> <span class="cm-operator">+</span> <span class="cm-variable">Pillow_archive_file</span> <span class="cm-operator">+</span> <span class="cm-string">' -d '</span> <span class="cm-operator">+</span> <span class="cm-variable">Pillow_archive_file_dir</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">sys</span>.<span class="cm-property">path</span>.<span class="cm-property">append</span>(<span class="cm-variable">Pillow_archive_file_dir</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 必须解压statsmodels包,否则使用不了so链接库</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Pillow_archive_file2</span> <span class="cm-operator">=</span> <span class="cm-string">'http://xxx.com/scheduler/res?id=264591628'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Pillow_archive_file_dir</span> <span class="cm-operator">=</span> <span class="cm-variable">os</span>.<span class="cm-property">path</span>.<span class="cm-property">dirname</span>(<span class="cm-variable">Pillow_archive_file2</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">os</span>.<span class="cm-property">system</span>(<span class="cm-string">'unzip '</span> <span class="cm-operator">+</span> <span class="cm-variable">Pillow_archive_file2</span> <span class="cm-operator">+</span> <span class="cm-string">' -d '</span> <span class="cm-operator">+</span> <span class="cm-variable">Pillow_archive_file_dir</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">sys</span>.<span class="cm-property">path</span>.<span class="cm-property">append</span>(<span class="cm-variable">Pillow_archive_file_dir</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># kats包</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">libs</span> <span class="cm-operator">=</span> [<span class="cm-string">'http://xxx.com/scheduler/res?id=265937401'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># dateutil包</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ,<span class="cm-string">'http://xxx.com/scheduler/res?id=266111495'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># ax-platform</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># typeguard</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ,<span class="cm-string">'http://xxx.com/scheduler/res?id=264843190'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># botorch</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  ,<span class="cm-string">'http://xxx.com/scheduler/res?id=264840378'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; ]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">lib_path</span> <span class="cm-operator">=</span> [ <span class="cm-variable">os</span>.<span class="cm-property">path</span>.<span class="cm-property">abspath</span>(<span class="cm-variable">f</span>) <span class="cm-keyword">for</span> <span class="cm-variable">f</span> <span class="cm-keyword">in</span> <span class="cm-variable">libs</span> ]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">print</span>(<span class="cm-string">'lib_path:'</span>, <span class="cm-variable">lib_path</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 不包含动态库的zip可以直接往sys.path中添加依赖</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> <span class="cm-variable">f</span> <span class="cm-keyword">in</span> <span class="cm-variable">lib_path</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">sys</span>.<span class="cm-property">path</span>.<span class="cm-property">append</span>(<span class="cm-variable">f</span>) </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">numpy</span> <span class="cm-keyword">as</span> <span class="cm-variable">np</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">pandas</span> <span class="cm-keyword">as</span> <span class="cm-variable">pd</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">pyarrow</span> <span class="cm-keyword">as</span> <span class="cm-variable">pa</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># pyodps已有的dateutil包是2.5.3而上传的matplotlib需要依赖dateutil2.7版本及以上才可以，重载方式可解决</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">importlib</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">dateutil</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">importlib</span>.<span class="cm-property">reload</span>(<span class="cm-variable">dateutil</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># import statsmodels.tsa.exponential_smoothing</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># print('exponential_smoothing:',statsmodels.tsa.exponential_smoothing)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># import statsmodels.tsa.exponential_smoothing._ets_smooth</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># print('_ets_smooth:',statsmodels.tsa.exponential_smoothing._ets_smooth)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 拷贝libta到/usr目录（只引入到syspath测试无用）</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">odps</span>.<span class="cm-property">udf</span> <span class="cm-keyword">import</span> <span class="cm-variable">annotate</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">odps</span>.<span class="cm-property">distcache</span> <span class="cm-keyword">import</span> <span class="cm-variable">get_cache_archive</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">odps</span>.<span class="cm-property">distcache</span> <span class="cm-keyword">import</span> <span class="cm-variable">get_cache_file</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">odps</span> <span class="cm-keyword">import</span> <span class="cm-variable">options</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">odps</span> <span class="cm-keyword">import</span> <span class="cm-variable">ODPS</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">include_file</span>(<span class="cm-variable">file_name</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">import</span> <span class="cm-variable">os</span>, <span class="cm-variable">sys</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">so_file</span> <span class="cm-operator">=</span> <span class="cm-variable">get_cache_file</span>(<span class="cm-variable">file_name</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">with</span> <span class="cm-builtin">open</span>(<span class="cm-variable">so_file</span>.<span class="cm-property">name</span>, <span class="cm-string">'rb'</span>) <span class="cm-keyword">as</span> <span class="cm-variable">fp</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">content</span><span class="cm-operator">=</span><span class="cm-variable">fp</span>.<span class="cm-property">read</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">so</span> <span class="cm-operator">=</span> <span class="cm-builtin">open</span>(<span class="cm-string">"/usr/lib64/libta_lib.so.0"</span>, <span class="cm-string">"wb"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">so</span>.<span class="cm-property">write</span>(<span class="cm-variable">content</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">so</span>.<span class="cm-property">flush</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">so</span>.<span class="cm-property">close</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 读入odps表，读入数据已经全部预处理完毕，该模块本身不进行校验</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">read_table</span>(<span class="cm-variable">table_name</span>, <span class="cm-variable">cols</span>, <span class="cm-variable">max_num</span><span class="cm-operator">=</span><span class="cm-number">1e10</span>, <span class="cm-variable">ptn</span><span class="cm-operator">=</span><span class="cm-keyword">None</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">ptn</span> <span class="cm-keyword">is</span> <span class="cm-keyword">not</span> <span class="cm-keyword">None</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment"># ps：get_table()方法是有获取1w条数据的限制</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">record_iterator</span> <span class="cm-operator">=</span> <span class="cm-variable">o</span>.<span class="cm-property">read_table</span>(<span class="cm-variable">table_name</span>, <span class="cm-variable">partition</span><span class="cm-operator">=</span><span class="cm-variable">ptn</span>, <span class="cm-variable">timeout</span><span class="cm-operator">=</span><span class="cm-number">6000</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">else</span> :</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">record_iterator</span> <span class="cm-operator">=</span> <span class="cm-variable">o</span>.<span class="cm-property">read_table</span>(<span class="cm-variable">table_name</span>, <span class="cm-variable">timeout</span><span class="cm-operator">=</span><span class="cm-number">6000</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">datas</span> <span class="cm-operator">=</span> {}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">for</span> <span class="cm-variable">cur_record</span> <span class="cm-keyword">in</span> <span class="cm-variable">record_iterator</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> <span class="cm-variable">col</span> <span class="cm-keyword">in</span> <span class="cm-variable">cols</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">tmp</span> <span class="cm-operator">=</span> <span class="cm-variable">datas</span>.<span class="cm-property">get</span>(<span class="cm-variable">col</span>,[])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> <span class="cm-variable">col</span> <span class="cm-keyword">in</span> (<span class="cm-string">"item_id"</span>, <span class="cm-string">"periods_cnt"</span>, ):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">tmp</span>.<span class="cm-property">append</span>(<span class="cm-builtin">int</span>(<span class="cm-variable">cur_record</span>[<span class="cm-variable">col</span>]))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">else</span> :</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">tmp</span>.<span class="cm-property">append</span>(<span class="cm-variable">cur_record</span>[<span class="cm-variable">col</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">datas</span>[<span class="cm-variable">col</span>] <span class="cm-operator">=</span> <span class="cm-variable">tmp</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">return</span> <span class="cm-variable">datas</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 检测结果写入odps表</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">def</span> <span class="cm-def">write_table</span>(<span class="cm-variable">records</span>, <span class="cm-variable">out_table</span>, <span class="cm-variable">cols</span>, <span class="cm-variable">ptn</span><span class="cm-operator">=</span><span class="cm-keyword">None</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">t</span> <span class="cm-operator">=</span> <span class="cm-variable">o</span>.<span class="cm-property">get_table</span>(<span class="cm-variable">out_table</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">if</span> <span class="cm-builtin">len</span>(<span class="cm-variable">records</span>) <span class="cm-operator">&lt;</span> <span class="cm-number">1</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">return</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin">print</span>(<span class="cm-string">'write_table onecase:'</span>, <span class="cm-builtin">len</span>(<span class="cm-variable">records</span>),<span class="cm-variable">records</span>[<span class="cm-number">0</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">if</span> <span class="cm-variable">ptn</span> <span class="cm-keyword">is</span> <span class="cm-keyword">not</span> <span class="cm-keyword">None</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">t</span>.<span class="cm-property">delete_partition</span>(<span class="cm-string">'ds='</span> <span class="cm-operator">+</span> <span class="cm-variable">ptn</span>, <span class="cm-variable">if_exists</span><span class="cm-operator">=</span><span class="cm-keyword">True</span>) &nbsp;<span class="cm-comment"># 存在的时候才删除</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">with</span> <span class="cm-variable">t</span>.<span class="cm-property">open_writer</span>(<span class="cm-variable">partition</span><span class="cm-operator">=</span><span class="cm-string">'ds='</span> <span class="cm-operator">+</span> <span class="cm-variable">ptn</span>, <span class="cm-variable">create_partition</span><span class="cm-operator">=</span><span class="cm-keyword">True</span>,<span class="cm-variable">arrow</span><span class="cm-operator">=</span><span class="cm-keyword">True</span>) <span class="cm-keyword">as</span> <span class="cm-variable">writer</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">df</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>.<span class="cm-property">DataFrame</span>(<span class="cm-variable">records</span>, <span class="cm-variable">columns</span><span class="cm-operator">=</span><span class="cm-variable">cols</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 写入 RecordBatch</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">batch</span> <span class="cm-operator">=</span> <span class="cm-variable">pa</span>.<span class="cm-property">RecordBatch</span>.<span class="cm-property">from_pandas</span>(<span class="cm-variable">df</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">writer</span>.<span class="cm-property">write</span>(<span class="cm-variable">batch</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">else</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">t</span>.<span class="cm-property">truncate</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">with</span> <span class="cm-variable">t</span>.<span class="cm-property">open_writer</span>() <span class="cm-keyword">as</span> <span class="cm-variable">writer</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">writer</span>.<span class="cm-property">write</span>(<span class="cm-variable">records</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># include_file('_ets_smooth.cpython-37m-x86_64-linux-gnu.so')</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># import ax</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># import torch</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># import kats.utils.time_series_parameter_tuning as tpt</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">from</span> <span class="cm-variable">kats</span>.<span class="cm-property">consts</span> <span class="cm-keyword">import</span> <span class="cm-variable">TimeSeriesData</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">from</span> <span class="cm-variable">kats</span>.<span class="cm-property">detectors</span>.<span class="cm-property">cusum_detection</span> <span class="cm-keyword">import</span> <span class="cm-variable">CUSUMDetector</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">from</span> <span class="cm-variable">kats</span>.<span class="cm-property">detectors</span>.<span class="cm-property">robust_stat_detection</span> <span class="cm-keyword">import</span> <span class="cm-variable">RobustStatDetector</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 离群点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">from</span> <span class="cm-variable">kats</span>.<span class="cm-property">detectors</span>.<span class="cm-property">outlier</span> <span class="cm-keyword">import</span> <span class="cm-variable">OutlierDetector</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">from</span> <span class="cm-variable">kats</span>.<span class="cm-property">detectors</span>.<span class="cm-property">outlier</span> <span class="cm-keyword">import</span> <span class="cm-variable">MultivariateAnomalyDetector</span>, <span class="cm-variable">MultivariateAnomalyDetectorType</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">from</span> <span class="cm-variable">kats</span>.<span class="cm-property">detectors</span>.<span class="cm-property">bocpd</span> <span class="cm-keyword">import</span> <span class="cm-variable">BOCPDetector</span>, <span class="cm-variable">BOCPDModelType</span>, <span class="cm-variable">TrendChangeParameters</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">from</span> <span class="cm-variable">kats</span>.<span class="cm-property">models</span>.<span class="cm-property">var</span> <span class="cm-keyword">import</span> <span class="cm-variable">VARParams</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">import</span> <span class="cm-variable">json</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">from</span> <span class="cm-variable">datetime</span> <span class="cm-keyword">import</span> <span class="cm-variable">datetime</span>, <span class="cm-variable">timedelta</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># from kats.models.anomaly_detector import AnomalyDetector</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># from kats.detectors import level_shift_detector</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">def</span> <span class="cm-def">toJson</span>():</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">data</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'name'</span>: <span class="cm-string">'Alice'</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'age'</span>: <span class="cm-number">18</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'gender'</span>: <span class="cm-string">'female'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 指定编码格式</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">json_str</span> <span class="cm-operator">=</span> <span class="cm-variable">json</span>.<span class="cm-property">dumps</span>(<span class="cm-variable">data</span>, <span class="cm-variable">ensure_ascii</span><span class="cm-operator">=</span><span class="cm-keyword">False</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin">print</span>(<span class="cm-string">'toJson'</span>,<span class="cm-variable">json_str</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">def</span> <span class="cm-def">testDetection</span>():</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># from kats.consts import TimeSeriesData</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># from kats.models.prophet import ProphetModel</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin cm-error">print</span>(<span class="cm-string">'testDetectionDs'</span>,<span class="cm-variable">args</span>[<span class="cm-string">'bizdate'</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># simulate time series with increase</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin cm-error">print</span>(<span class="cm-string">'======222===='</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">np</span>.<span class="cm-property">random</span>.<span class="cm-property">seed</span>(<span class="cm-number">10</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">df_increase</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>.<span class="cm-property">DataFrame</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'time'</span>: <span class="cm-variable">pd</span>.<span class="cm-property">date_range</span>(<span class="cm-string">'2019-01-01'</span>, <span class="cm-string">'2019-03-01'</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'increase'</span>:<span class="cm-variable">np</span>.<span class="cm-property">concatenate</span>([<span class="cm-variable">np</span>.<span class="cm-property">random</span>.<span class="cm-property">normal</span>(<span class="cm-number">1</span>,<span class="cm-number">0.2</span>,<span class="cm-number">30</span>), <span class="cm-variable">np</span>.<span class="cm-property">random</span>.<span class="cm-property">normal</span>(<span class="cm-number">2</span>,<span class="cm-number">0.2</span>,<span class="cm-number">30</span>)]),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  )</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin">print</span>(<span class="cm-string">'df_increase'</span>,<span class="cm-variable">df_increase</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># convert to TimeSeriesData object</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">timeseries</span> <span class="cm-operator">=</span> <span class="cm-variable">TimeSeriesData</span>(<span class="cm-variable">df_increase</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># run detector and find change points</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">change_points</span> <span class="cm-operator">=</span> <span class="cm-variable">CUSUMDetector</span>(<span class="cm-variable">timeseries</span>).<span class="cm-property">detector</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin cm-error">print</span>(<span class="cm-string">'change_points'</span>,<span class="cm-variable">change_points</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">def</span> <span class="cm-def">testOrderDetection</span>():</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 假设orders是一个列表，包含每天的订单数量</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">orders</span> <span class="cm-operator">=</span> [<span class="cm-number">10</span>, <span class="cm-number">15</span>, <span class="cm-number">14</span>, <span class="cm-number">17</span>, <span class="cm-number">12</span>, <span class="cm-number">1</span>, <span class="cm-number">25</span>, <span class="cm-number">28</span>, <span class="cm-number">30</span>, <span class="cm-number">14</span>, <span class="cm-number">18</span>, <span class="cm-number">11</span>, <span class="cm-number">15</span>, <span class="cm-number">16</span>, <span class="cm-number">19</span>, <span class="cm-number">22</span>, <span class="cm-number">23</span>, <span class="cm-number">25</span>, <span class="cm-number">21</span>, <span class="cm-number">20</span>, <span class="cm-number">30</span>, <span class="cm-number">35</span>, <span class="cm-number">40</span>, <span class="cm-number">50</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 将数据转换为TimeSeriesData格式</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># data = TimeSeriesData(time=pd.date_range(start='2021-01-01', periods=len(orders), freq='D'), </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; value=orders)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 将列表转换为pandas.Series</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">series</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>.<span class="cm-property">Series</span>(<span class="cm-variable">orders</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 将数据转换为TimeSeriesData格式</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">data</span> <span class="cm-operator">=</span> <span class="cm-variable">TimeSeriesData</span>(<span class="cm-variable">time</span><span class="cm-operator">=</span><span class="cm-variable">pd</span>.<span class="cm-property">date_range</span>(<span class="cm-variable">start</span><span class="cm-operator">=</span><span class="cm-string">'20230701'</span>, <span class="cm-variable">periods</span><span class="cm-operator">=</span><span class="cm-builtin">len</span>(<span class="cm-variable">series</span>), <span class="cm-variable">freq</span><span class="cm-operator">=</span><span class="cm-string">'D'</span>), </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">value</span><span class="cm-operator">=</span><span class="cm-variable">series</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin">print</span>(<span class="cm-string">'TimeSeriesData data:'</span>,<span class="cm-variable">data</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 创建异常检测器对象</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># detector = AnomalyDetector(data=data, granularity='day', threshold=3.0)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 创建CUSUMDetector对象，并设置阈值为2.0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">detector</span> <span class="cm-operator">=</span> <span class="cm-variable">CUSUMDetector</span>(<span class="cm-variable">data</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 进行异常检测</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">change_points</span> <span class="cm-operator">=</span> <span class="cm-variable">detector</span>.<span class="cm-property">detector</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 输出结果</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin">print</span>(<span class="cm-string">'testOrderDetection'</span>,<span class="cm-variable">change_points</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">def</span> <span class="cm-def">CUSUMDetectorMean</span>(<span class="cm-variable">startDs</span>, <span class="cm-variable">data</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># synthesize data with simulation</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># orders = [54,59,72, 86, 177, 72, 76, 58, 45, 63, 55, 218, 217, 39, 17, 31, 31, 17, 16, 24, 27, 22, 28, 20, 29, 21, 25, 30, 20, 74, 145, 89, 30, 426, 53, 645, 542, 938, 171, 952, 780, 952, 1006, 914, 512, 596, 655, 610, 786, 952, 1198, 142, 128, 66, 87, 100, 74, 64, 106, 85, 86, 106]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># orders_one_m = [89, 30, 426, 53, 645, 542, 938, 171, 952, 780, 952, 1006, 914, 512, 596, 655, 610, 786, 952, 1198, 142, 128, 66, 87, 100, 74, 64, 106, 85, 86, 106]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">orders_one_m</span> <span class="cm-operator">=</span> <span class="cm-variable">data</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># np.random.seed(10)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">series</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>.<span class="cm-property">Series</span>(<span class="cm-variable">orders_one_m</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">df_increase_decrease</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>.<span class="cm-property">DataFrame</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'time'</span>: <span class="cm-variable">pd</span>.<span class="cm-property">date_range</span>(<span class="cm-variable">startDs</span>, <span class="cm-variable">periods</span><span class="cm-operator">=</span><span class="cm-builtin">len</span>(<span class="cm-variable">series</span>)),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'increase'</span>:<span class="cm-variable">series</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'decrease'</span>:<span class="cm-variable">series</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  )</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin">print</span>(<span class="cm-string">'TimeSeriesData data:'</span>,<span class="cm-variable">df_increase_decrease</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 突变点监测1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># tsd = TimeSeriesData(df_increase_decrease.loc[:,['time','increase']])</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># detector = CUSUMDetector(tsd)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># change_points = detector.detector(change_directions=["increase"], max_iter=20,return_all_changepoints=True)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># print('CUSUMDetector 突变点监测1:',change_points)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">kv_multi_cp_ts</span> <span class="cm-operator">=</span> <span class="cm-variable">df_increase_decrease</span>.<span class="cm-property">to_dict</span>(<span class="cm-variable">orient</span><span class="cm-operator">=</span><span class="cm-string">'records'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">for</span> <span class="cm-variable">d</span> <span class="cm-keyword">in</span> <span class="cm-variable">kv_multi_cp_ts</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">d</span>[<span class="cm-string">'time'</span>] <span class="cm-operator">=</span> <span class="cm-variable">d</span>[<span class="cm-string">'time'</span>].<span class="cm-property">strftime</span>(<span class="cm-string">'%Y%m%d'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">new_kv_multi_cp_ts</span> <span class="cm-operator">=</span> {<span class="cm-variable">d</span>[<span class="cm-string">'time'</span>]: <span class="cm-variable">d</span>[<span class="cm-string">'decrease'</span>] <span class="cm-keyword">for</span> <span class="cm-variable">d</span> <span class="cm-keyword">in</span> <span class="cm-variable">kv_multi_cp_ts</span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 突变点监测2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">tsd</span> <span class="cm-operator">=</span> <span class="cm-variable">TimeSeriesData</span>(<span class="cm-variable">df_increase_decrease</span>.<span class="cm-property">loc</span>[:,[<span class="cm-string">'time'</span>,<span class="cm-string">'decrease'</span>]])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">detector</span> <span class="cm-operator">=</span> <span class="cm-variable">CUSUMDetector</span>(<span class="cm-variable">tsd</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">change_points</span> <span class="cm-operator">=</span> <span class="cm-variable">detector</span>.<span class="cm-property">detector</span>(<span class="cm-variable">change_directions</span><span class="cm-operator">=</span>[<span class="cm-string">"decrease"</span>],<span class="cm-variable">max_iter</span><span class="cm-operator">=</span><span class="cm-number">10</span>,<span class="cm-variable">return_all_changepoints</span><span class="cm-operator">=</span><span class="cm-keyword">True</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin cm-error">print</span>(<span class="cm-string">'CUSUMDetector 突变点监测decrease:'</span>,<span class="cm-variable">change_points</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># detector.plot(change_points)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">return</span> <span class="cm-variable">changePToDict</span>(<span class="cm-variable">new_kv_multi_cp_ts</span>, <span class="cm-variable">change_points</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># plt.xticks(rotation=45)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># detector.plot(change_points)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># plt.show()</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">def</span> <span class="cm-def">CUSUMDetectorWithMultipleChangeP</span>(<span class="cm-variable">startDs</span>, <span class="cm-variable">data</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">orders</span> <span class="cm-operator">=</span> [<span class="cm-number">54</span>,<span class="cm-number">59</span>,<span class="cm-number">72</span>, <span class="cm-number">86</span>, <span class="cm-number">177</span>, <span class="cm-number">72</span>, <span class="cm-number">76</span>, <span class="cm-number">58</span>, <span class="cm-number">45</span>, <span class="cm-number">63</span>, <span class="cm-number">55</span>, <span class="cm-number">218</span>, <span class="cm-number">217</span>, <span class="cm-number">39</span>, <span class="cm-number">17</span>, <span class="cm-number">31</span>, <span class="cm-number">31</span>, <span class="cm-number">17</span>, <span class="cm-number">16</span>, <span class="cm-number">24</span>, <span class="cm-number">27</span>, <span class="cm-number">22</span>, <span class="cm-number">28</span>, <span class="cm-number">20</span>, <span class="cm-number">29</span>, <span class="cm-number">21</span>, <span class="cm-number">25</span>, <span class="cm-number">30</span>, <span class="cm-number">20</span>, <span class="cm-number">74</span>, <span class="cm-number">145</span>, <span class="cm-number">89</span>, <span class="cm-number">30</span>, <span class="cm-number">426</span>, <span class="cm-number">53</span>, <span class="cm-number">645</span>, <span class="cm-number">542</span>, <span class="cm-number">938</span>, <span class="cm-number">171</span>, <span class="cm-number">952</span>, <span class="cm-number">780</span>, <span class="cm-number">952</span>, <span class="cm-number">1006</span>, <span class="cm-number">914</span>, <span class="cm-number">512</span>, <span class="cm-number">596</span>, <span class="cm-number">655</span>, <span class="cm-number">610</span>, <span class="cm-number">786</span>, <span class="cm-number">952</span>, <span class="cm-number">1198</span>, <span class="cm-number">142</span>, <span class="cm-number">128</span>, <span class="cm-number">66</span>, <span class="cm-number">87</span>, <span class="cm-number">100</span>, <span class="cm-number">74</span>, <span class="cm-number">64</span>, <span class="cm-number">106</span>, <span class="cm-number">85</span>, <span class="cm-number">86</span>, <span class="cm-number">106</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># orders_one_m = [89, 30, 426, 53, 645, 542, 938, 171, 952, 780, 952, 1006, 914, 512, 596, 655, 610, 786, 952, 1198, 142, 128, 66, 87, 100, 74, 64, 106, 85, 86, 106]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">orders_one_m</span> <span class="cm-operator">=</span> <span class="cm-variable">data</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># np.random.seed(10)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">series</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>.<span class="cm-property">Series</span>(<span class="cm-variable">orders_one_m</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">df_multi_cps</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>.<span class="cm-property">DataFrame</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'time'</span>: <span class="cm-variable">pd</span>.<span class="cm-property">date_range</span>(<span class="cm-variable">startDs</span>, <span class="cm-variable">periods</span><span class="cm-operator">=</span><span class="cm-builtin">len</span>(<span class="cm-variable">series</span>)),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'y'</span>:<span class="cm-variable">series</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  )</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">multi_cp_ts</span> <span class="cm-operator">=</span> <span class="cm-variable">TimeSeriesData</span>(<span class="cm-variable">df_multi_cps</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">kv_multi_cp_ts</span> <span class="cm-operator">=</span> <span class="cm-variable">df_multi_cps</span>.<span class="cm-property">to_dict</span>(<span class="cm-variable">orient</span><span class="cm-operator">=</span><span class="cm-string">'records'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">for</span> <span class="cm-variable">d</span> <span class="cm-keyword">in</span> <span class="cm-variable">kv_multi_cp_ts</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">d</span>[<span class="cm-string">'time'</span>] <span class="cm-operator">=</span> <span class="cm-variable">d</span>[<span class="cm-string">'time'</span>].<span class="cm-property">strftime</span>(<span class="cm-string">'%Y%m%d'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">new_kv_multi_cp_ts</span> <span class="cm-operator">=</span> {<span class="cm-variable">d</span>[<span class="cm-string">'time'</span>]: <span class="cm-variable">d</span>[<span class="cm-string">'y'</span>] <span class="cm-keyword">for</span> <span class="cm-variable">d</span> <span class="cm-keyword">in</span> <span class="cm-variable">kv_multi_cp_ts</span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin cm-error">print</span>(<span class="cm-string">'CUSUMDetectorWithMultipleChangePTest input:'</span>,<span class="cm-variable">new_kv_multi_cp_ts</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">n</span> <span class="cm-operator">=</span> <span class="cm-builtin">len</span>(<span class="cm-variable">df_multi_cps</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">historical_window</span> <span class="cm-operator">=</span> <span class="cm-number">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">scan_window</span> <span class="cm-operator">=</span> <span class="cm-variable">n</span> <span class="cm-operator">-</span> <span class="cm-number">1</span> <span class="cm-keyword">if</span> <span class="cm-variable">n</span> <span class="cm-operator">&lt;</span> <span class="cm-number">10</span> <span class="cm-keyword">else</span> <span class="cm-number">10</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">step</span> <span class="cm-operator">=</span> <span class="cm-number">5</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">changepoints</span> <span class="cm-operator">=</span> []</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin cm-error">print</span>(<span class="cm-string">'scan_window:'</span>,<span class="cm-variable">scan_window</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># for end_idx in range(0, n, step):</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">for</span> <span class="cm-variable">end_idx</span> <span class="cm-keyword">in</span> <span class="cm-builtin">range</span>(<span class="cm-variable">historical_window</span> <span class="cm-operator">+</span> <span class="cm-variable">scan_window</span>, <span class="cm-variable">n</span>, <span class="cm-variable">step</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">tsd</span> <span class="cm-operator">=</span> <span class="cm-variable">multi_cp_ts</span>[<span class="cm-variable">end_idx</span> <span class="cm-operator">-</span> (<span class="cm-variable">historical_window</span> <span class="cm-operator">+</span> <span class="cm-variable">scan_window</span>) : <span class="cm-variable">end_idx</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># tsd = multi_cp_ts[end_idx  : end_idx + step]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin cm-error">print</span>(<span class="cm-string">'多窗口输入检测:'</span>,<span class="cm-variable">end_idx</span>,<span class="cm-variable">tsd</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">changepoints</span> <span class="cm-operator">+=</span> <span class="cm-variable">CUSUMDetector</span>(<span class="cm-variable">tsd</span>).<span class="cm-property">detector</span>(<span class="cm-variable">change_directions</span><span class="cm-operator">=</span>[<span class="cm-string">"decrease"</span>],<span class="cm-variable">interest_window</span><span class="cm-operator">=</span>[<span class="cm-variable">historical_window</span>, <span class="cm-variable">historical_window</span> <span class="cm-operator">+</span> <span class="cm-variable">scan_window</span>],<span class="cm-variable">max_iter</span><span class="cm-operator">=</span><span class="cm-number">10</span>,<span class="cm-variable">return_all_changepoints</span><span class="cm-operator">=</span><span class="cm-keyword">True</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin cm-error">print</span>(<span class="cm-string">'CUSUMDetector 多异常点检测:'</span>,<span class="cm-variable">changepoints</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">return</span> <span class="cm-variable">changePToDict</span>(<span class="cm-variable">new_kv_multi_cp_ts</span>, <span class="cm-variable">changepoints</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 转为字典</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">def</span> <span class="cm-def">changePToDict</span>(<span class="cm-variable">series_kv</span>,<span class="cm-variable">changepoints</span>,<span class="cm-variable">dictType</span><span class="cm-operator">=</span><span class="cm-keyword">None</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">cp_dict_list</span> <span class="cm-operator">=</span> []</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">if</span> <span class="cm-variable">dictType</span> <span class="cm-keyword">is</span> <span class="cm-keyword">None</span> <span class="cm-keyword">or</span> &nbsp;<span class="cm-variable">dictType</span> <span class="cm-operator">==</span> <span class="cm-string">'CUSUMChangePoint'</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">for</span> <span class="cm-variable">cp</span> <span class="cm-keyword">in</span> <span class="cm-variable">changepoints</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">happenTime</span> <span class="cm-operator">=</span> <span class="cm-variable">cp</span>.<span class="cm-property">start_time</span> <span class="cm-operator">+</span> <span class="cm-variable">timedelta</span>(<span class="cm-variable">days</span><span class="cm-operator">=</span><span class="cm-number">1</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">startDs</span> <span class="cm-operator">=</span> <span class="cm-variable">cp</span>.<span class="cm-property">start_time</span>.<span class="cm-property">strftime</span>(<span class="cm-string">'%Y%m%d'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">happenDs</span> <span class="cm-operator">=</span> <span class="cm-variable">happenTime</span>.<span class="cm-property">strftime</span>(<span class="cm-string">'%Y%m%d'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin">print</span>(<span class="cm-string">'changePToDict:'</span>,<span class="cm-variable">series_kv</span>[<span class="cm-variable">startDs</span>],<span class="cm-variable">series_kv</span>[<span class="cm-variable">happenDs</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">if</span> <span class="cm-variable">happenDs</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">args</span>[<span class="cm-string">'bizdate'</span>]:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">continue</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">c</span> <span class="cm-operator">=</span> <span class="cm-variable">cp</span>.<span class="cm-property">confidence</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">cp_dict</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 'start_time': pd.to_datetime(cp.start_time).strftime('%Y%m%d'),</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 'end_time': pd.to_datetime(cp.end_time).strftime('%Y%m%d'),</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'happen_time'</span>: <span class="cm-variable">happenDs</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'confidence'</span>: <span class="cm-variable">cp</span>.<span class="cm-property">confidence</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'direction'</span>: <span class="cm-variable">cp</span>.<span class="cm-property">direction</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'delta'</span>: <span class="cm-variable">cp</span>.<span class="cm-property">delta</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'regression_detected'</span>: <span class="cm-builtin">str</span>(<span class="cm-variable">cp</span>.<span class="cm-property">regression_detected</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'stable_changepoint'</span>: <span class="cm-builtin">str</span>(<span class="cm-variable">cp</span>.<span class="cm-property">stable_changepoint</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'mu0'</span>: <span class="cm-variable">cp</span>.<span class="cm-property">mu0</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'mu1'</span>: <span class="cm-variable">cp</span>.<span class="cm-property">mu1</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'llr'</span>: <span class="cm-variable">cp</span>.<span class="cm-property">llr</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'llr_int'</span>: <span class="cm-variable">cp</span>.<span class="cm-property">llr_int</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'p_value'</span>: <span class="cm-variable">cp</span>.<span class="cm-property">p_value</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ,<span class="cm-string">'p_value_int'</span>: <span class="cm-variable">cp</span>.<span class="cm-property">p_value_int</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">#  约束条件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">if</span> <span class="cm-variable">c</span> <span class="cm-operator">&gt;</span> <span class="cm-number">0.7</span> <span class="cm-keyword">and</span> <span class="cm-variable">series_kv</span>[<span class="cm-variable">happenDs</span>] <span class="cm-operator">&lt;</span> <span class="cm-variable">series_kv</span>[<span class="cm-variable">startDs</span>]:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">cp_dict_list</span>.<span class="cm-property">append</span>(<span class="cm-variable">cp_dict</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">elif</span> <span class="cm-variable">dictType</span> <span class="cm-operator">==</span> <span class="cm-string">'TimeSeriesChangePoint'</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">for</span> <span class="cm-variable">cp</span> <span class="cm-keyword">in</span> <span class="cm-variable">changepoints</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 返回的是timestamp类型 </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">startDs</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>.<span class="cm-property">to_datetime</span>(<span class="cm-variable">cp</span>.<span class="cm-property">start_time</span>).<span class="cm-property">strftime</span>(<span class="cm-string">'%Y%m%d'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">happenTime</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>.<span class="cm-property">to_datetime</span>(<span class="cm-variable">cp</span>.<span class="cm-property">start_time</span>) <span class="cm-operator">+</span> <span class="cm-variable">timedelta</span>(<span class="cm-variable">days</span><span class="cm-operator">=</span><span class="cm-number">1</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">happenDs</span> <span class="cm-operator">=</span> <span class="cm-variable">happenTime</span>.<span class="cm-property">strftime</span>(<span class="cm-string">'%Y%m%d'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin cm-error">print</span>(<span class="cm-string">'TimeSeriesChangePoint:'</span>,<span class="cm-variable">series_kv</span>,<span class="cm-variable">series_kv</span>[<span class="cm-variable">startDs</span>],<span class="cm-variable">series_kv</span>[<span class="cm-variable">happenDs</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">cp_dict</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 'start_time': pd.to_datetime(cp.start_time).strftime('%Y%m%d'),</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 'end_time': pd.to_datetime(cp.end_time).strftime('%Y%m%d'),</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'happen_time'</span>: <span class="cm-variable">happenDs</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'confidence'</span>: <span class="cm-variable">cp</span>.<span class="cm-property">confidence</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">if</span> <span class="cm-variable">happenDs</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">args</span>[<span class="cm-string">'bizdate'</span>]:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">continue</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">if</span> <span class="cm-variable">series_kv</span>[<span class="cm-variable">happenDs</span>] <span class="cm-operator">&lt;</span> <span class="cm-variable">series_kv</span>[<span class="cm-variable">startDs</span>]:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">cp_dict_list</span>.<span class="cm-property">append</span>(<span class="cm-variable">cp_dict</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">elif</span> <span class="cm-variable">dictType</span> <span class="cm-operator">==</span> <span class="cm-string">'time_series'</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">for</span> <span class="cm-variable">cp</span> <span class="cm-keyword">in</span> <span class="cm-variable">changepoints</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">startDs</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>.<span class="cm-property">to_datetime</span>(<span class="cm-variable">cp</span>).<span class="cm-property">strftime</span>(<span class="cm-string">'%Y%m%d'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">happenTime</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>.<span class="cm-property">to_datetime</span>(<span class="cm-variable">cp</span>) <span class="cm-operator">+</span> <span class="cm-variable">timedelta</span>(<span class="cm-variable">days</span><span class="cm-operator">=</span><span class="cm-number">1</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">happenDs</span> <span class="cm-operator">=</span> <span class="cm-variable">happenTime</span>.<span class="cm-property">strftime</span>(<span class="cm-string">'%Y%m%d'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">if</span> <span class="cm-variable">happenDs</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">args</span>[<span class="cm-string">'bizdate'</span>]:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">continue</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin">print</span>(<span class="cm-string">'time_series:'</span>,<span class="cm-variable">series_kv</span>,<span class="cm-variable">series_kv</span>[<span class="cm-variable">startDs</span>],<span class="cm-variable">series_kv</span>[<span class="cm-variable">happenDs</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">if</span> <span class="cm-variable">series_kv</span>[<span class="cm-variable">happenDs</span>] <span class="cm-operator">&lt;</span> <span class="cm-variable">series_kv</span>[<span class="cm-variable">startDs</span>]:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">cp_dict_list</span>.<span class="cm-property">append</span>({</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'happen_time'</span>: <span class="cm-variable">happenDs</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; })</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin">print</span>(<span class="cm-string">'changePToDict:'</span>,<span class="cm-variable">cp_dict_list</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">return</span> <span class="cm-variable">json</span>.<span class="cm-property">dumps</span>(<span class="cm-variable">cp_dict_list</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">def</span> <span class="cm-def">BOCPDetectorAM</span>(<span class="cm-variable">startDs</span>, <span class="cm-variable">data</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># from kats.utils.simulator import Simulator</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># sim = Simulator(n=450, start='2020-01-01', freq='H')</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># ts_bocpd = sim.level_shift_sim(noise=0.05, seasonal_period=1)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">orders_one_m</span> <span class="cm-operator">=</span> <span class="cm-variable">data</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">series</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>.<span class="cm-property">Series</span>(<span class="cm-variable">orders_one_m</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">df</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>.<span class="cm-property">DataFrame</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'time'</span>: <span class="cm-variable">pd</span>.<span class="cm-property">date_range</span>(<span class="cm-variable">startDs</span>, <span class="cm-variable">periods</span><span class="cm-operator">=</span><span class="cm-builtin">len</span>(<span class="cm-variable">series</span>)),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'value'</span>:<span class="cm-variable">series</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 'increase':series,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 'decrease':series</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  )</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">ts_bocpd</span> <span class="cm-operator">=</span> <span class="cm-variable">TimeSeriesData</span>(<span class="cm-variable">df</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin">print</span>(<span class="cm-string">'BOCPDetector input:'</span>,<span class="cm-variable">ts_bocpd</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># Initialize the detector</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">detector</span> <span class="cm-operator">=</span> <span class="cm-variable">BOCPDetector</span>(<span class="cm-variable">ts_bocpd</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">changepoints</span> <span class="cm-operator">=</span> <span class="cm-variable">detector</span>.<span class="cm-property">detector</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin">print</span>(<span class="cm-string">'BOCPDetector input:'</span>,<span class="cm-variable">changepoints</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">def</span> <span class="cm-def">RobustStatDetectorMean</span>(<span class="cm-variable">startDs</span>, <span class="cm-variable">data</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">orders</span> <span class="cm-operator">=</span> [<span class="cm-number">54</span>,<span class="cm-number">59</span>,<span class="cm-number">72</span>, <span class="cm-number">86</span>, <span class="cm-number">177</span>, <span class="cm-number">72</span>, <span class="cm-number">76</span>, <span class="cm-number">58</span>, <span class="cm-number">45</span>, <span class="cm-number">63</span>, <span class="cm-number">55</span>, <span class="cm-number">218</span>, <span class="cm-number">217</span>, <span class="cm-number">39</span>, <span class="cm-number">17</span>, <span class="cm-number">31</span>, <span class="cm-number">31</span>, <span class="cm-number">17</span>, <span class="cm-number">16</span>, <span class="cm-number">24</span>, <span class="cm-number">27</span>, <span class="cm-number">22</span>, <span class="cm-number">28</span>, <span class="cm-number">20</span>, <span class="cm-number">29</span>, <span class="cm-number">21</span>, <span class="cm-number">25</span>, <span class="cm-number">30</span>, <span class="cm-number">20</span>, <span class="cm-number">74</span>, <span class="cm-number">145</span>, <span class="cm-number">89</span>, <span class="cm-number">30</span>, <span class="cm-number">426</span>, <span class="cm-number">53</span>, <span class="cm-number">645</span>, <span class="cm-number">542</span>, <span class="cm-number">938</span>, <span class="cm-number">171</span>, <span class="cm-number">952</span>, <span class="cm-number">780</span>, <span class="cm-number">952</span>, <span class="cm-number">1006</span>, <span class="cm-number">914</span>, <span class="cm-number">512</span>, <span class="cm-number">596</span>, <span class="cm-number">655</span>, <span class="cm-number">610</span>, <span class="cm-number">786</span>, <span class="cm-number">952</span>, <span class="cm-number">1198</span>, <span class="cm-number">142</span>, <span class="cm-number">128</span>, <span class="cm-number">66</span>, <span class="cm-number">87</span>, <span class="cm-number">100</span>, <span class="cm-number">74</span>, <span class="cm-number">64</span>, <span class="cm-number">106</span>, <span class="cm-number">85</span>, <span class="cm-number">86</span>, <span class="cm-number">106</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># orders_one_m = [89, 30, 426, 53, 645, 542, 938, 171, 952, 780, 952, 1006, 914, 512, 596, 655, 610, 786, 952, 1198, 142, 128, 66, 87, 100, 74, 64, 106, 85, 86, 106]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># np.random.seed(10)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">orders_one_m</span> <span class="cm-operator">=</span> <span class="cm-variable">data</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">series</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>.<span class="cm-property">Series</span>(<span class="cm-variable">orders_one_m</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">df_increase_decrease</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>.<span class="cm-property">DataFrame</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'time'</span>: <span class="cm-variable">pd</span>.<span class="cm-property">date_range</span>(<span class="cm-variable">startDs</span>, <span class="cm-variable">periods</span><span class="cm-operator">=</span><span class="cm-builtin">len</span>(<span class="cm-variable">series</span>)),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'value'</span>:<span class="cm-variable">series</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 'increase':series,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 'decrease':series</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  )</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin cm-error">print</span>(<span class="cm-string">'BOCPDetector input:'</span>,<span class="cm-variable">df_increase_decrease</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">kv_multi_cp_ts</span> <span class="cm-operator">=</span> <span class="cm-variable">df_increase_decrease</span>.<span class="cm-property">to_dict</span>(<span class="cm-variable">orient</span><span class="cm-operator">=</span><span class="cm-string">'records'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">for</span> <span class="cm-variable">d</span> <span class="cm-keyword">in</span> <span class="cm-variable">kv_multi_cp_ts</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">d</span>[<span class="cm-string">'time'</span>] <span class="cm-operator">=</span> <span class="cm-variable">d</span>[<span class="cm-string">'time'</span>].<span class="cm-property">strftime</span>(<span class="cm-string">'%Y%m%d'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">new_kv_multi_cp_ts</span> <span class="cm-operator">=</span> {<span class="cm-variable">d</span>[<span class="cm-string">'time'</span>]: <span class="cm-variable">d</span>[<span class="cm-string">'value'</span>] <span class="cm-keyword">for</span> <span class="cm-variable">d</span> <span class="cm-keyword">in</span> <span class="cm-variable">kv_multi_cp_ts</span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">tsd</span> <span class="cm-operator">=</span> <span class="cm-variable">TimeSeriesData</span>(<span class="cm-variable">df_increase_decrease</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">detector</span> <span class="cm-operator">=</span> <span class="cm-variable">RobustStatDetector</span>(<span class="cm-variable">tsd</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">change_points</span> <span class="cm-operator">=</span> <span class="cm-variable">detector</span>.<span class="cm-property">detector</span>(<span class="cm-variable">p_value_cutoff</span> <span class="cm-operator">=</span> <span class="cm-number">5e-3</span>, <span class="cm-variable">comparison_window</span><span class="cm-operator">=</span><span class="cm-number">2</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin">print</span>(<span class="cm-string">'RobustStatDetector 突变点监测:'</span>,<span class="cm-variable">change_points</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">return</span> <span class="cm-variable">changePToDict</span>(<span class="cm-variable">new_kv_multi_cp_ts</span>, <span class="cm-variable">change_points</span>,<span class="cm-string">'TimeSeriesChangePoint'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">def</span> <span class="cm-def">OutlierDetectorDecomp</span>(<span class="cm-variable">startDs</span>, <span class="cm-variable">data</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># orders = [54,59,72, 86, 177, 72, 76, 58, 45, 63, 55, 218, 217, 39, 17, 31, 31, 17, 16, 24, 27, 22, 28, 20, 29, 21, 25, 30, 20, 74, 145, 89, 30, 426, 53, 645, 542, 938, 171, 952, 780, 952, 1006, 914, 512, 596, 655, 610, 786, 952, 1198, 142, 128, 66, 87, 100, 74, 64, 106, 85, 86, 106]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># orders_one_m = [89, 30, 426, 53, 645, 542, 938, 171, 952, 780, 952, 1006, 914, 512, 596, 655, 610, 786, 952, 1198, 142, 128, 66, 87, 100, 74, 64, 106, 85, 86, 106]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># np.random.seed(10)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">orders_one_m</span> <span class="cm-operator">=</span> <span class="cm-variable">data</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">series</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>.<span class="cm-property">Series</span>(<span class="cm-variable">orders_one_m</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">df_increase_decrease</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>.<span class="cm-property">DataFrame</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'time'</span>: <span class="cm-variable">pd</span>.<span class="cm-property">date_range</span>(<span class="cm-variable">startDs</span>, <span class="cm-variable">periods</span><span class="cm-operator">=</span><span class="cm-builtin">len</span>(<span class="cm-variable">series</span>)),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'value'</span>:<span class="cm-variable">series</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  )</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin cm-error">print</span>(<span class="cm-string">'TimeSeriesData data:'</span>,<span class="cm-variable">df_increase_decrease</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">kv_multi_cp_ts</span> <span class="cm-operator">=</span> <span class="cm-variable">df_increase_decrease</span>.<span class="cm-property">to_dict</span>(<span class="cm-variable">orient</span><span class="cm-operator">=</span><span class="cm-string">'records'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">for</span> <span class="cm-variable">d</span> <span class="cm-keyword">in</span> <span class="cm-variable">kv_multi_cp_ts</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">d</span>[<span class="cm-string">'time'</span>] <span class="cm-operator">=</span> <span class="cm-variable">d</span>[<span class="cm-string">'time'</span>].<span class="cm-property">strftime</span>(<span class="cm-string">'%Y%m%d'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">new_kv_multi_cp_ts</span> <span class="cm-operator">=</span> {<span class="cm-variable">d</span>[<span class="cm-string">'time'</span>]: <span class="cm-variable">d</span>[<span class="cm-string">'value'</span>] <span class="cm-keyword">for</span> <span class="cm-variable">d</span> <span class="cm-keyword">in</span> <span class="cm-variable">kv_multi_cp_ts</span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">tsd</span> <span class="cm-operator">=</span> <span class="cm-variable">TimeSeriesData</span>(<span class="cm-variable">df_increase_decrease</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">ts_outlierDetection</span> <span class="cm-operator">=</span> <span class="cm-variable">OutlierDetector</span>(<span class="cm-variable">tsd</span>, <span class="cm-string">'additive'</span>) </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">ts_outlierDetection</span>.<span class="cm-property">detector</span>() </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin">print</span>(<span class="cm-string">'OutlierDetectorDecomp 离群点:'</span>,<span class="cm-variable">ts_outlierDetection</span>.<span class="cm-property">outliers</span>[<span class="cm-number">0</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">return</span> <span class="cm-variable">changePToDict</span>(<span class="cm-variable">new_kv_multi_cp_ts</span>, <span class="cm-variable">ts_outlierDetection</span>.<span class="cm-property">outliers</span>[<span class="cm-number">0</span>], <span class="cm-string">'time_series'</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 检测跨多个时间序列的异常</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">def</span> <span class="cm-def">MultivariateAnomalyDetectorCrossMultiSeries</span>(<span class="cm-variable">startDs</span>, <span class="cm-variable">data</span>):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">orders_one_m</span> <span class="cm-operator">=</span> <span class="cm-variable">data</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">series</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>.<span class="cm-property">Series</span>(<span class="cm-variable">orders_one_m</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">df_increase_decrease</span> <span class="cm-operator">=</span> <span class="cm-variable">pd</span>.<span class="cm-property">DataFrame</span>(</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'time'</span>: <span class="cm-variable">pd</span>.<span class="cm-property">date_range</span>(<span class="cm-variable">startDs</span>, <span class="cm-variable">periods</span><span class="cm-operator">=</span><span class="cm-builtin">len</span>(<span class="cm-variable">series</span>)),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">'value'</span>:<span class="cm-variable">series</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  )</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin">print</span>(<span class="cm-string">'TimeSeriesData data:'</span>,<span class="cm-variable">df_increase_decrease</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">multi_anomaly_ts</span> <span class="cm-operator">=</span> <span class="cm-variable">TimeSeriesData</span>(<span class="cm-variable">df_increase_decrease</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">params</span> <span class="cm-operator">=</span> <span class="cm-variable">VARParams</span>(<span class="cm-variable">maxlags</span><span class="cm-operator">=</span><span class="cm-number">2</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">d</span> <span class="cm-operator">=</span> <span class="cm-variable">MultivariateAnomalyDetector</span>(<span class="cm-variable">multi_anomaly_ts</span>, <span class="cm-variable">params</span>, <span class="cm-variable">training_days</span><span class="cm-operator">=</span><span class="cm-number">60</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">anomaly_score_df</span> <span class="cm-operator">=</span> <span class="cm-variable">d</span>.<span class="cm-property">detector</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin cm-error">print</span>(<span class="cm-string">'MultivariateAnomalyDetector anomaly_score_df:'</span>,<span class="cm-variable">anomaly_score_df</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 检测</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">anomalies</span> <span class="cm-operator">=</span> <span class="cm-variable">d</span>.<span class="cm-property">get_anomaly_timepoints</span>(<span class="cm-variable">alpha</span><span class="cm-operator">=</span><span class="cm-number">0.05</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin">print</span>(<span class="cm-string">'MultivariateAnomalyDetector 离群点:'</span>,<span class="cm-variable">anomalies</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 离群点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># ts_outlierDetection.outliers[0]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># print('OutlierDetector 离群点监测:',ts_outlierDetection,ts_outlierDetection.outliers[0])</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword">if</span> <span class="cm-variable">__name__</span> <span class="cm-operator">==</span> <span class="cm-string">'__main__'</span>:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># testDetection()</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># testOrderDetection()</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">CUSUMDetectorMean</span>(<span class="cm-string">'20230602'</span>,[<span class="cm-number">301</span>, <span class="cm-number">444</span>, <span class="cm-number">245</span>, <span class="cm-number">216</span>, <span class="cm-number">231</span>, <span class="cm-number">204</span>, <span class="cm-number">180</span>, <span class="cm-number">181</span>, <span class="cm-number">201</span>, <span class="cm-number">182</span>, <span class="cm-number">210</span>, <span class="cm-number">213</span>, <span class="cm-number">240</span>, <span class="cm-number">530</span>, <span class="cm-number">499</span>, <span class="cm-number">506</span>, <span class="cm-number">938</span>, <span class="cm-number">527</span>, <span class="cm-number">694</span>, <span class="cm-number">242</span>, <span class="cm-number">393</span>, <span class="cm-number">454</span>, <span class="cm-number">506</span>, <span class="cm-number">406</span>, <span class="cm-number">304</span>, <span class="cm-number">316</span>, <span class="cm-number">277</span>, <span class="cm-number">256</span>, <span class="cm-number">236</span>, <span class="cm-number">238</span>, <span class="cm-number">247</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># res1 = CUSUMDetectorWithMultipleChangeP('20230604',[258, 206, 252, 194, 10])</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># print('CUSUMDetectorWithMultipleChangeP', res1)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># RobustStatDetectorMean('20230602',[301, 444, 245, 216, 231, 204, 180, 181, 201, 182, 210, 213, 240, 530, 499, 506, 938, 527, 694, 242, 393, 454, 506, 406, 304, 316, 277, 256, 236, 238, 247])</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># OutlierDetectorDecomp('20230604',[709, 679, 651, 560, 492, 435, 579, 789, 644, 579, 449, 560, 624, 544, 683, 346, 300, 267, 367, 381, 371, 346, 321, 336, 312, 4815, 454, 309, 405, 356])</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># MultivariateAnomalyDetectorCrossMultiSeries('20230602',[301, 444, 245, 216, 231, 204, 180, 0, 0, 0, 210, 213, 240, 530, 499, 506, 938, 527, 694, 242, 393, 454, 506, 406, 304, 316, 277, 256, 236, 238, 247])</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># toJson()</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># BOCPDetectorAM('20230602',[301, 444, 245, 216, 231, 204, 180, 181, 201, 182, 210, 213, 240, 530, 499, 506, 938, 527, 694, 242, 393, 454, 506, 406, 304, 316, 277, 256, 236, 238, 247])</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 数据源定义</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">input_tables</span> <span class="cm-operator">=</span>  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">"input_total"</span>: <span class="cm-string">"huopin_data.item_ord_detection_kats_algo_input"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">output_tables</span> <span class="cm-operator">=</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">"detection_result"</span>: <span class="cm-string">"huopin_data.item_ord_detection_kats_algo_res_opt"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 读取数据源</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># read input info,output ini_dict like {col1:[val1_1,val1_2,...],col2:[val2_1,val2_2,...],...}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">ini_input_dict</span> <span class="cm-operator">=</span> <span class="cm-variable">read_table</span>(<span class="cm-variable">input_tables</span>[<span class="cm-string">"input_total"</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ,<span class="cm-variable">cols</span><span class="cm-operator">=</span>[</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">"item_id"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ,<span class="cm-string">"start_ds"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ,<span class="cm-string">"ord_arr"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ,<span class="cm-string">"extend_json"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ],</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">ptn</span><span class="cm-operator">=</span><span class="cm-string">'ds='</span><span class="cm-operator">+</span><span class="cm-variable">args</span>[<span class="cm-string">'bizdate'</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-builtin cm-error">print</span>(<span class="cm-string">'ini_input_dict len:'</span>,<span class="cm-builtin">len</span>(<span class="cm-variable">ini_input_dict</span>[<span class="cm-string">'item_id'</span>]))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">detection_res</span> <span class="cm-operator">=</span> []</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-keyword cm-error">for</span> <span class="cm-variable">i</span> <span class="cm-keyword">in</span> <span class="cm-builtin">range</span>(<span class="cm-builtin">len</span>(<span class="cm-variable">ini_input_dict</span>[<span class="cm-string">'item_id'</span>])):</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">itemId</span> <span class="cm-operator">=</span> <span class="cm-variable">ini_input_dict</span>[<span class="cm-string">'item_id'</span>][<span class="cm-variable">i</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">res_0</span> <span class="cm-operator">=</span> <span class="cm-variable">CUSUMDetectorMean</span>(<span class="cm-variable">ini_input_dict</span>[<span class="cm-string">'start_ds'</span>][<span class="cm-variable">i</span>],<span class="cm-variable">ini_input_dict</span>[<span class="cm-string">'ord_arr'</span>][<span class="cm-variable">i</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">res_1</span> <span class="cm-operator">=</span> <span class="cm-variable">CUSUMDetectorWithMultipleChangeP</span>(<span class="cm-variable">ini_input_dict</span>[<span class="cm-string">'start_ds'</span>][<span class="cm-variable">i</span>],<span class="cm-variable">ini_input_dict</span>[<span class="cm-string">'ord_arr'</span>][<span class="cm-variable">i</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">res_3</span> <span class="cm-operator">=</span> <span class="cm-variable">RobustStatDetectorMean</span>(<span class="cm-variable">ini_input_dict</span>[<span class="cm-string">'start_ds'</span>][<span class="cm-variable">i</span>],<span class="cm-variable">ini_input_dict</span>[<span class="cm-string">'ord_arr'</span>][<span class="cm-variable">i</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable cm-error">res_4</span> <span class="cm-operator">=</span> <span class="cm-variable">OutlierDetectorDecomp</span>(<span class="cm-variable">ini_input_dict</span>[<span class="cm-string">'start_ds'</span>][<span class="cm-variable">i</span>],<span class="cm-variable">ini_input_dict</span>[<span class="cm-string">'ord_arr'</span>][<span class="cm-variable">i</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">detection_res</span>.<span class="cm-property">append</span>([<span class="cm-variable">itemId</span>, <span class="cm-variable">res_0</span>, <span class="cm-variable">res_1</span>,<span class="cm-string">'[]'</span>,<span class="cm-variable">res_3</span>,<span class="cm-variable">res_4</span>, <span class="cm-string">'[]'</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># 输出结果 </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">write_table</span>(<span class="cm-variable">detection_res</span>, <span class="cm-variable">output_tables</span>[<span class="cm-string">'detection_result'</span>],[<span class="cm-string">'item_id'</span>,<span class="cm-string">'detection_res_of_cusum'</span>,<span class="cm-string">'detection_res_of_cusum_window'</span>,<span class="cm-string">'detection_res_of_bocp'</span>,<span class="cm-string">'detection_res_of_robuststat'</span>,<span class="cm-string">'detection_res_of_outlier'</span>,<span class="cm-string">'detection_res_of_var'</span>],<span class="cm-variable">args</span>[<span class="cm-string">'bizdate'</span>])</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment"># print('======end=====')</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 12078px;"></div><div class="CodeMirror-gutters" style="display: none; height: 12078px;"></div></div></div></pre></div></div>
        </article>
        <script src="/js/av-min.js"></script>
        <script src="/js/Valine.min.js"></script>
        <div class="blog-post-comments"></div>
        <script>new Valine({
            el: '.blog-post-comments',
            app_id: '4pa6G5f3p9sLCmmqRgPTN8Qg-gzGzoHsz',
            app_key: 'xlVmYRcq8N3Feir3eh5SXUuu',
            placeholder: '说点什么?',
            avatar: 'robohash',
            notify: true,
            verify: true
        });</script>
    </section>
</div>
<footer id="footer">
    <div class="footer-left">Email © shzzjut@163.com
    </div>
    <div class="footer-right">
        <nav>
            <ul>
                <li><a href="/">主页</a></li>
                <li><a href="/blog/">博客</a></li>
                <li><a href="/about/">关于我</a></li>
                <li><a href="http://github.com/dzg123" target="_blank">Github</a></li>
            </ul>
        </nav>
    </div>
</footer>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/lib/typed.js"></script>
<script src="/js/main.js"></script>
<script async src=""></script>
<script>(function () {
    var imgArr = document.getElementsByTagName("img");
    for (var i = 0; i < imgArr.length; i++) {
        if (imgArr[i].width > 600) {
            var radio = imgArr[i].width / imgArr[i].height;
            imgArr[i].width = 600;
            imgArr[i].height = 600 / radio;
        }
        if (imgArr[i].height > 400) {
             radio = imgArr[i].width / imgArr[i].height;
            imgArr[i].height = 400;
            imgArr[i].width = 400 * radio;
        }
    }
    var ga = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    ga.src = 'https://www.googletagmanager.com/gtag/js?id=UA-129382678-1';
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(ga, s);
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());

    gtag('config', 'UA-129382678-1');
})()</script>
<script>(function () {
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    } else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();</script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js?t=1540207086409')
            .then(function () {
                console.log('ServiceWorker Register Successfully.')
            })
            .catch(function (e) {
                console.error(e)
            });
    }
</script>
</body>
</html>